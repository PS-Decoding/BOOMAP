<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://drive.google.com">
  <link rel="preconnect" href="https://lh3.googleusercontent.com">
  <link rel="dns-prefetch" href="https://drive.google.com">
  <link rel="dns-prefetch" href="https://lh3.googleusercontent.com">
  <link rel="icon" href="https://raw.githubusercontent.com/PS-Decoding/BOOMAP/refs/heads/main/BOOMAP_icon/web/favicon.ico" type="image/png">
  <style>
    :root{
      /* í‚¤ ì»¬ëŸ¬ & íŒ”ë ˆíŠ¸ */
      --BOOMAP_KEY: #76679E;      /* Reign Over Me (PPG1248-7) */
      --KEY-RGB: 118,103,158;     
      --RED:   #AD1A34;           /* SEOUL RED */
      --RED-RGB: 174,25,50;     
      --GREEN: #4A8061;           /* Viridian */
      --GREEN-RGB: 74,128,97;
      --BLUE:  #113F97;           /* HAN BLUE */
      --BLUE-RGB: 1,32,201;

      /* ì»´í¬ë„ŒíŠ¸ ê³µí†µ ì¹˜ìˆ˜ */
      --fab-size: 42px;           /* ë ˆì´ì–´/ë²”ë¡€ FAB ì§€ë¦„ */
      --zoom-width: 30px;         /* .ctrl.zoom.nv-fullì˜ width */
    }
    /* ===== ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ===== */
    html, body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple SD Gothic Neo","Noto Sans KR","ë§‘ì€ ê³ ë”•",sans-serif; }
    body { overflow:hidden; }
    #app { display:grid; grid-template-columns:minmax(310px,340px) 1fr; height:100vh; min-height:620px; background:#f8fafc; }
    #sidebar { border-right:1px solid #e5e7eb; padding:0 10px 10px; overflow:auto; background:#fff; }
    #map { width:100%; height:100%; min-height:620px; overflow:hidden; position:relative; }

    /* ===== ìš°ìƒë‹¨ ì»¨íŠ¸ë¡¤ ===== */
    /* ë§µíƒ€ì… ì„¸ê·¸ë¨¼íŠ¸: ì™¸ê³½ í…Œë‘ë¦¬ ì œê±° */
    .maptype.segmented{
      position:relative;
      display:flex;
      width:128px; height:30px;
      border:none;                 /* â† ì™¸ê³½ í…Œë‘ë¦¬ ì—†ìŒ */
      border-radius:12px;
      background:#fff;             /* ë°”íƒ• */
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      overflow:hidden; gap:0;
      background-clip:padding-box;
    }
    /* ì„ íƒ ìƒíƒœì— ë”°ë¼ ë°˜ë°˜ ë°°ê²½ë§Œ ë°”ê¿”ì¤Œ */
    .maptype.segmented.is-road{
      background-image:linear-gradient(to right,var(--BOOMAP_KEY) 0 50%,#fff 50% 100%);
    }
    .maptype.segmented.is-sky{
      background-image:linear-gradient(to right,#fff 0 50%,var(--BOOMAP_KEY) 50% 100%);
    }
    /* ë²„íŠ¼ ìì²´ëŠ” íˆ¬ëª… + ì˜ì—­ ê½‰ ì±„ìš°ê¸°(50%/50%) */
    .maptype.segmented .seg{
      flex:1 0 50%;
      height:100%;
      display:flex; align-items:center; justify-content:center;
      margin:0; padding:0;
      border:0; background:transparent;
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      font-weight:800; font-size:12px; line-height:1;
      user-select:none; cursor:pointer;
      color:#374151;                 /* ê¸°ë³¸ ê¸€ììƒ‰(ë¹„ì„ íƒìª½) */
    }
    /* ì„ íƒ ìª½ ê¸€ìë§Œ í°ìƒ‰ */
    .maptype.segmented.is-road .seg:first-child{ color:#fff; }
    .maptype.segmented.is-sky  .seg:last-child { color:#fff; }

    /* í¬ì»¤ìŠ¤/í•˜ì´ë¼ì´íŠ¸ ì™„ì „ ì œê±° */
    .maptype.segmented .seg:focus,
    .maptype.segmented .seg:focus-visible{ outline:none; box-shadow:none; }

    /* === ì¤Œ ì»¨íŠ¸ë¡¤(ì»´íŒ©íŠ¸) â€” ì ˆë°˜ ì´í•˜ë¡œ ì¶•ì†Œ & íŠ¸ë™ ì ˆë°˜ ë‘ê»˜ === */
    .ctrl.zoom.nv-full{
      width:30px;                      /* 56 â†’ 30 (ì ˆë°˜ ì´í•˜) */
      border:1px solid #cfcfd4; border-radius:14px; background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      display:flex; flex-direction:column; align-items:center;
      padding:4px 0;
    }
    .zbtn.sym{
      width:100%; height:28px;         /* 40 â†’ 28 */
      border:0; background:transparent;
      font-size:16px; font-weight:900; line-height:1; color:var(--BOOMAP_KEY);
      cursor:pointer; user-select:none; display:flex; align-items:center; justify-content:center;
    }
    .zbtn.sym svg{ display:block; }
    .zdiv{ width:100%; height:1px; background:#cfcfd4; }

    .zcenter{ position:relative; width:100%; height:140px; display:flex; align-items:center; justify-content:center; }

    .zguide{ position:absolute; inset:8px 0; pointer-events:none; }
    .zguide .gt{ position:absolute; left:0; right:0; height:1px; background:transparent; }
    .zguide .gt::before, .zguide .gt::after{
      content:""; position:absolute; top:0; width:16px; height:1px; background:#c0c2c7; /* ëˆˆê¸ˆ ê¸¸ì´ ì¶•ì†Œ */
    }
    .zguide .gt::before{ left:6px; }
    .zguide .gt::after { right:6px; }

    /* ì¤‘ì•™ íŠ¸ë™/ì±„ì›€/ì†ì¡ì´ */
    .zbar{
      position:absolute; top:8px; bottom:8px; left:50%; transform:translateX(-50%);
      width:5px;                        /* 10 â†’ 5 (ì ˆë°˜ ë‘ê»˜) */
      border-radius:6px; background:#b9bbc0;
      cursor:pointer;                   /* íŠ¸ë™ í´ë¦­ë„ í—ˆìš© */
    }
    .zfill{
      position:absolute; left:0; right:0; bottom:0;
      height:0%; border-radius:6px; will-change: height; background:rgba(var(--KEY-RGB),.9);
    }
    .zthumb{
      position:absolute;
      left:50%;
      transform: translateX(-50%);   /* â† Y ì˜¤í”„ì…‹ ì œê±° */
      top:0;                          /* JSì—ì„œ pxë¡œ ì •í™•íˆ ì„¤ì • */
      width:22px; height:6px;
      border-radius:2px;
      background:#fff;
      border:1px solid #9aa0a6;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
      pointer-events:none;
    }
    #ctrlDockTR{
      align-items: flex-end;
    }
    .ctrl.zoom.nv-full{
      margin-right: calc((var(--fab-size) - var(--zoom-width)) / 2); /* = 6px */
    }
    /* ì¤Œ íŠ¸ë™ ë“œë˜ê·¸ UX */
    .zbar{
      cursor: grab;
      touch-action: none;   /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤/ì¤Œ ì œìŠ¤ì²˜ ì°¨ë‹¨ */
    }
    .zbar.dragging{ cursor: grabbing; }

    /* ===== ê²€ìƒ‰ ë„í¬(FABâ†’ë°”) ===== */
    .map-searchdock{ position:absolute; top:10px; left:10px; z-index:12000; display:flex; align-items:center; }
    .fabsearch{
      box-sizing:border-box; position:relative; height:42px; width:42px;
      padding-left:0; border:1px solid #e5e7eb; border-radius:999px; background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.08); display:flex; align-items:center; overflow:hidden;
      transition:width .24s ease, box-shadow .18s ease, border-color .18s ease, padding-left .18s ease;
    }
    .fabsearch.open{ width:256px; padding-left:42px; border-color:#e5e7eb; box-shadow:0 2px 12px rgba(0,0,0,.10); }
    .fabsearch.searched{
      border-color: var(--BOOMAP_KEY);
      border-width: 2px;
      box-shadow: 0 4px 16px rgba(var(--KEY-RGB), .22);
    }
    .fabsearch .icon{
      position:absolute; left:0; top:50%; transform:translateY(-50%);
      width:42px; height:42px; display:flex; align-items:center; justify-content:center;
    }
    .fabsearch .icon::before{
      content:""; width:22px; height:22px; display:block;
      background-repeat:no-repeat; background-position:center; background-size:22px 22px;
      background-image:url("data:image/svg+xml,%3Csvg width='22' height='22' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%236b7280' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='7'/%3E%3Cpath d='M20 20l-3.5-3.5'/%3E%3C/g%3E%3C/svg%3E");
    }
    .fabsearch input{
      flex:1 1 auto; min-width:0; border:0; outline:0; background:transparent;
      font-size:13px; padding:0 38px 0 6px; opacity:0; transition:opacity .14s ease;
    }
    .fabsearch.open input{ opacity: 1; max-width: none; }
    .fabsearch .btn-collapse{
      position:absolute; top:50%; transform:translateY(-50%);
      right:10px; width:26px; height:26px; border:0; background:transparent; cursor:pointer;
      font-size:18px; line-height:1; color:#9ca3af; opacity:.95; pointer-events:none;
    }
    .fabsearch.open .btn-collapse{ pointer-events:auto; }
    .fabsearch:not(.open) input,
    .fabsearch:not(.open) .btn-collapse{ display:none !important; }

    /* ê²€ìƒ‰ ì•ˆë‚´ í† ìŠ¤íŠ¸ */
    .search-hint{
      position:absolute;
      top: 52px;        /* FAB(42px) ì•„ë˜ë¡œ ì‚´ì§ */
      left: 0;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      background:#ffffff;
      color:var(--BOOMAP_KEY);
      border:1px solid rgba(var(--KEY-RGB), .35);
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      opacity:0;
      transform: translateY(-4px);
      pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 12020;   /* ê²€ìƒ‰ ë„í¬(12000)ë³´ë‹¤ ìœ„ */
    }
    .search-hint.show{
      opacity:1;
      transform: translateY(0);
    }

    /* === ê²€ìƒ‰ íŒ¨ë„ ì˜¤ë²„ë ˆì´(ë§ˆì»¤ ìœ„) : í†µì¼ ë²„ì „ === */
    .search-panel.overlay{
      position: relative;
      /* â†“ ê¸°ë³¸ .search-panelì˜ left/top ì˜¤í”„ì…‹ ë¬´íš¨í™” */
      left: auto;
      top: auto;

      /* â†“ ë¸”ë¡ í™•ì¥ì„ ë§‰ì•„ í­ì´ ë‚´ìš©ë§Œí¼ë§Œ ë˜ê²Œ */
      display: inline-block;
      box-sizing: border-box;

      inline-size: max-content; 
      min-inline-size: 220px; 
      max-inline-size: min(92vw, 560px);
      transform: none;
      opacity: 1;
      pointer-events: auto;
      padding: 0;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      background: #fff;
      z-index: 12060;
    }
    .search-panel.overlay .head{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      background: var(--BOOMAP_KEY); color:#fff; padding:6px 8px;
    }
    .search-panel.overlay .head .icon{
      width:18px; height:18px; display:inline-block; flex:0 0 18px;
      background-repeat:no-repeat; background-position:center; background-size:18px 18px;
      margin-right:6px; opacity:.95;
      background-image:url("data:image/svg+xml,%3Csvg width='18' height='18' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23ffffff' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='7'/%3E%3Cpath d='M20 20l-3.5-3.5'/%3E%3C/g%3E%3C/svg%3E");
    }
    .search-panel.overlay .head .title{
      flex: 1 1 auto;          /* ë‚´ìš©ì— ë”°ë¼ ëŠ˜ì–´ë‚˜ë˜ í•„ìš”í•˜ë©´ ì¤„ì–´ë“¦ */
      font-size:12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;  /* ìƒí•œì„ (560px ë˜ëŠ” 92vw) ë„˜ìœ¼ë©´ â€¦ ì²˜ë¦¬ */
    }
    .search-panel.overlay .head .panel-close{
      position:static; width:24px; height:24px; border:0; background:transparent; color:#fff;
      cursor:pointer; line-height:24px; font-size:18px;
    }
    .search-panel.overlay .body{ padding:8px 10px; }
    .search-panel.overlay .kv{ display:flex; align-items:center; gap:8px; padding:6px 0; }
    .search-panel.overlay .kv .k{
      flex:0 0 20px; width:20px; height:20px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center; font-weight:800; font-size:12px;
      color:#fff; background: var(--BOOMAP_KEY);
    }
    .search-panel.overlay .kv .v{
      flex: 1 1 auto;          /* ë‚´ìš© ê¸¸ì´ë§Œí¼ íŒ¨ë„ì´ ë¨¼ì € ëŠ˜ì–´ë‚˜ë„ë¡ */
      white-space: nowrap;
      overflow: hidden;
      font-size:13px;
      text-overflow: ellipsis;  /* ìƒí•œì„  ë„˜ëŠ” ê²½ìš°ì—ë§Œ â€¦ */
    }
    .search-panel.overlay:after{
      content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-8px;
      width:14px; height:8px; background:#fff; border-left:1px solid rgba(0,0,0,.08);
      border-bottom:1px solid rgba(0,0,0,.08); clip-path: polygon(0 0, 50% 100%, 100% 0);
    }
    .search-panel.overlay .head .title,
    .search-panel.overlay .kv .v{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* ê³µìœ  ë‹«ê¸° ë²„íŠ¼(ê²€ìƒ‰ íŒ¨ë„ê³¼ ë™ì¼ í†¤) */
    .panel-close{
      position:static; width:24px; height:24px; border:0; background:transparent; color:#fff;
      cursor:pointer; line-height:24px; font-size:18px;
    }

    /* ê²€ìƒ‰ í•€ */
    .search-pin{
      position:relative; width:14px; height:14px; border-radius:50%;
      background: var(--BOOMAP_KEY); border:2px solid #fff; box-shadow:0 2px 10px rgba(0,0,0,.18);
    }
    .search-pin::after{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      border:2px solid rgba(var(--KEY-RGB), .70); animation:ping 1.8s ease-out infinite;
    }
    @keyframes ping{ 0%{ transform:scale(.6); opacity:.9; } 100%{ transform:scale(2.0); opacity:0; } }

    /* ===== ë ˆì´ì–´ ë„í¬(ì˜¤ë¥¸ìª½-í•˜ë‹¨) â€” í†µì¼ ë²„ì „ ===== */
    .map-layerbr{ position:absolute; right:14px; bottom:14px; z-index:12000; }
    .layer-wrap, .legend-wrap{ position:relative; }
    .layer-fab{
      width:42px; height:42px; border-radius:50%; border:1px solid #e5e7eb; background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.08); cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0;
    }
    .layer-fab::before{
      content:""; display:block; width:22px; height:22px; background-repeat:no-repeat; background-position:center; background-size:22px 22px;
      background-image:url("data:image/svg+xml,%3Csvg width='22' height='22' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 3L2 9l10 6 10-6-10-6z' stroke='%236b7280' stroke-width='1.6' fill='%23fff'/%3E%3Cpath d='M2 13l10 6 10-6' stroke='%236b7280' stroke-width='1.6' fill='none'/%3E%3C/svg%3E");
    }
    /* ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼(ì‘ê²Œ, ì¹© ìŠ¤íƒ€ì¼) */
    .btn-layer{
      border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:4px 10px;
      font-size:12px; font-weight:700; cursor:pointer;
    }
    .btn-layer.moa{  color:#065f46; border-color:#86efac; background:#dcfce7; }
    .btn-layer.fast{ color:#7f1d1d; border-color:#fecaca; background:#fee2e2; }

    /* êº¼ì§„ ìƒíƒœ(aria-pressed=false) í‘œí˜„ */
    .btn-layer[aria-pressed="false"]{
      opacity:.55; filter:saturate(.6);
    }

    .legend-fab{
      width:42px; height:42px; border-radius:50%; border:1px solid #e5e7eb; background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.08); cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0;
    }
    .legend-fab::before{
      content:""; display:block; width:22px; height:22px; background-repeat:no-repeat; background-position:center; background-size:22px 22px;
      /* 4ìƒ‰ íƒ€ì¼ ì•„ì´ì½˜ */
      background-image:url("data:image/svg+xml,%3Csvg width='22' height='22' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%23e5e7eb' stroke-width='0.5'%3E%3Crect x='3' y='3' width='8' height='8' rx='2' fill='%23ef4444'/%3E%3Crect x='13' y='3' width='8' height='8' rx='2' fill='%233b82f6'/%3E%3Crect x='3' y='13' width='8' height='8' rx='2' fill='%238b5cf6'/%3E%3Crect x='13' y='13' width='8' height='8' rx='2' fill='%2310b981'/%3E%3C/g%3E%3C/svg%3E");
    }
    /* ë²”ë¡€ íŒ¨ë„: ì™¼ìª½ìœ¼ë¡œ í¼ì¹¨ */
    .layer-panel,
    .legend-panel{
      position:absolute; right:calc(100% + 8px); bottom:0;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
      padding:6px 10px;
      display:inline-flex;              /* shrink-to-fit ìµœì†Œí™” */
      align-items:center;
      gap:8px;
      white-space:nowrap;               /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
      width:max-content;                /* ë‚´ìš© ê¸¸ì´ë§Œí¼ ê°€ë¡œ */
      z-index:12020;
    }

    .layer-panel.hidden,
    .legend-panel.hidden{ display:none; }

    /* ===== ì‚¬ì´ë“œë°”/ë¦¬ìŠ¤íŠ¸ ===== */
    /* ê±°ë˜ìœ í˜• ì¹© ë²„íŠ¼ */
    .typechips{
      display:flex; gap:0; width:100%;
      border:1px solid #cbd5e1;   /* ë°”ê¹¥ í…Œë‘ë¦¬ë§Œ ìœ ì§€ */
      border-radius:8px;
      overflow:hidden;
      background:#fff;
    }
    /* ê° ì¹© */
    .type-chip{
      flex:1 0 0;
      margin:0;
      padding:10px 0;
      border:0;                   /* ê°œë³„ í…Œë‘ë¦¬ ì—†ìŒ */
      background:#fff;
      color:#374151;
      font-size:12px; font-weight:800;
      cursor:pointer; user-select:none;
      transition:background .12s ease, color .12s ease;
    }
    /* ğŸ”¥ ê°€ìš´ë° ì„  ì œê±° */
    .type-chip + .type-chip{ border-left:0 !important; }
    /* í˜¸ë²„(ë¹„ì„ íƒ ìƒíƒœ) */
    .type-chip[aria-pressed="false"]:hover{ background:#f8fafc; }
    /* ì„ íƒ ìƒ‰ìƒ(ê¸€ì í°ìƒ‰ ê³ ì •) */
    .type-chip[aria-pressed="true"].k-all     { background: var(--BOOMAP_KEY); color:#fff; }
    .type-chip[aria-pressed="true"].k-sale    { background: var(--RED);        color:#fff; }
    .type-chip[aria-pressed="true"].k-jeonse  { background: var(--BLUE);       color:#fff; }
    .type-chip[aria-pressed="true"].k-monthly { background: var(--GREEN);      color:#fff; }

    /* í¬ì»¤ìŠ¤ */
    .type-chip:focus-visible{
      outline:2px solid rgba(var(--KEY-RGB), .45);
      outline-offset:2px;
    }

    .sidebar-header {
      position: sticky;
      top: 0;
      background: #fff;   /* â† í—¤ë”ë„ í°ìƒ‰ */
      z-index: 5;
      padding: 10px 2px 8px;
      border-bottom: 1px solid #f1f5f9;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar-header h3 { margin:0; font-size:16px; }
    .filter-group,
    .stat,
    #list .item {
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 10px;
    }
    .group-title { font-size:12px; color:#6b7280; margin:0 0 6px 2px; }
    .rowline { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }

    select, input[type="number"], input[type="text"] {
      padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; width:100%; font-size:13px; box-sizing:border-box;
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath d='M5.23 7.21a.75.75 0 011.06.02L10 11.146l3.71-3.915a.75.75 0 111.08 1.04l-4.24 4.47a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 10px center; background-size:14px 14px; padding-right:30px;
    }
    select::-ms-expand { display:none; }
    .w-110 { flex:0 0 140px; width:140px; max-width:140px; }
    .search-226 { flex:0 0 286px; width:286px; max-width:286px; }

    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      line-height:1.2;
      border:0;         
      color:#fff;     
      background:#999;  /* ê¸°ë³¸ê°’(í˜¹ì‹œ ìƒ‰ í´ë˜ìŠ¤ ëˆ„ë½ ëŒ€ë¹„) */
    }
    /* íƒ€ì…ë³„: í…Œë‘ë¦¬/ê¸€ììƒ‰ì„ íŒ”ë ˆíŠ¸ ë³€ìˆ˜ë¡œ í†µì¼ */
    .badge.red   { background: var(--RED);   color:#fff; }
    .badge.blue  { background: var(--BLUE);  color:#fff; }
    .badge.green { background: var(--GREEN); color:#fff; }

    .price { font-weight:800; font-size:18px; margin-left:8px; color:#111827; }
    .muted { color:#6b7280; }
    .dim { color:#9ca3af; }
    .small { font-size:12px; }
    .xsmall { font-size:11px; }

    .chip { border:1px solid #e5e7eb; border-radius:999px; padding:2px 8px; font-size:12px; background:#f9fafb; }
    .chip.ok{background:#ecfdf5;border-color:#d1fae5;color:#065f46;}
    .chip.no{background:#fef2f2;border-color:#fee2e2;color:#7f1d1d;}
    .chip.info{background:#eff6ff;border-color:#dbeafe;color:#1e40af;}

    .item { padding:10px 8px; border-bottom:1px solid #f1f5f9; font-size:13px; cursor:pointer; background:#fff; border-radius:8px; margin:5px 0; }
    .item:hover { background:#f8fafc; }
    .addr { font-weight:400; margin:6px 0 4px; color:#111827; }
    .meta { font-size:12px; color:#6b7280; }
    .rowchips { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .stat { font-size:12px; color:#666; margin-top:6px; }

    /* ===== ë§ˆì»¤ ë§í’ì„ (pill) & í™•ì¥ì¹´ë“œ ===== */
    .marker-bubble-wrap{ display:inline-flex; flex-direction:column; align-items:center; }
    .marker-bubble{
      position:relative; display:inline-flex; flex-direction:column; align-items:stretch;
      border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; font-size:12px;
      box-shadow:0 4px 14px rgba(0,0,0,.16); background:#fff;
    }
    .marker-tail{ width:12px; height:6px; background:#fff; border-left:1px solid rgba(0,0,0,.08); border-bottom:1px solid rgba(0,0,0,.08); clip-path: polygon(0 0, 50% 100%, 100% 0); margin-top:0; }
    .marker-bubble .sec{ padding:6px 10px; text-align:center; white-space:nowrap; line-height:1.2; }
    .marker-bubble .sec-top{ font-weight:700; color:#fff; }
    .marker-bubble .sec-bottom{ background:#fff; color:#111; font-weight:700; font-size:13px; }
    .marker-bubble .sec-top.red   { background:var(--RED); }
    .marker-bubble .sec-top.blue  { background:var(--BLUE); }
    .marker-bubble .sec-top.green { background:var(--GREEN); }

    .wrap {position:relative; width:320px; transform:scale(.92); opacity:0; transition:transform .18s ease, opacity .18s ease; }
    .wrap.show { transform:scale(1); opacity:1; }
    .wrap .info {width:320px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.16);}
    .info .title {padding:8px 12px;font-weight:700;color:#111827;border-radius:8px 8px 0 0;font-size:13px; white-space:normal; word-break:break-word; line-height:1.4;}
    .title.sale    { background:var(--RED);   color:#fff; }
    .title.jeonse  { background:var(--BLUE);  color:#fff; }
    .title.monthly { background:var(--GREEN); color:#fff; }
    .info .body {position:relative;padding:10px 12px;}
    .info:after {content:"";position:absolute;left:50%;transform:translateX(-10px);bottom:-10px;width:20px;height:10px;background:url('data:image/svg+xml,%3Csvg width="20" height="10" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M0,0 L10,10 L20,0" fill="%23ffffff" stroke="%23e5e7eb"/%3E%3C/svg%3E') no-repeat;}

    /* ===== ë ˆì´ì–´(ëª¨ì•„/ì‹ ì†): í˜¸ë²„ ë¼ë²¨ & ì¹´ë“œ ===== */
    .plan-label{
      position:relative; padding:6px 10px; border-radius:10px; font-size:12px; font-weight:700;
      background:#e8fff4; border:1px solid #b7f1d7; box-shadow:0 4px 14px rgba(0,0,0,.12); white-space:nowrap; color:#0b1a13;
    }
    .plan-label:after{
      content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-6px; width:10px; height:6px;
      background:inherit; border-left:1px solid rgba(0,0,0,.08); border-bottom:1px solid rgba(0,0,0,.08);
      clip-path: polygon(0 0, 50% 100%, 100% 0);
    }
    .plan-label.moa{ background:#dcfce7; border-color:#86efac; color:#064e3b; }
    .plan-label.fast{ background:#fee2e2; border-color:#fecaca; color:#7f1d1d; }
    .plan-card{
      display:inline-block; border-radius:10px; background:#fff; border:1px solid #e5e7eb; box-shadow:0 6px 18px rgba(0,0,0,.14); font-size:12px;
    }
    .plan-card .head{ padding:6px 10px; font-weight:700; line-height:1.35; font-size:12px; text-align:center; }
    .plan-card .body{ padding:6px 10px; color:#374151; text-align:center; }
    .plan-card .stage{ margin-top:2px; font-size:12px; color:#6b7280; }
    .plan-card.moa .head  { background:#dcfce7; color:#065f46; }
    .plan-card.fast .head { background:#fee2e2; color:#7f1d1d; }

    /* ===== ì¹´ë“œ ìƒë‹¨ ê°¤ëŸ¬ë¦¬ ===== */
    .gallery{ position:relative; width:100%; height:200px; background:#f3f4f6; border-bottom:1px solid #e5e7eb; overflow:hidden; }
    .gallery-inner{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .gallery img{ width:100%; height:100%; object-fit:cover; }
    .gallery-empty{ font-size:12px; color:#6b7280; }
    .gallery-prev,.gallery-next{
      position:absolute; top:50%; transform:translateY(-50%);
      width:32px; height:32px; border-radius:50%;
      border:1px solid #e5e7eb; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.12);
      cursor:pointer; font-size:18px; line-height:30px; text-align:center; user-select:none;
    }
    .gallery-prev{ left:8px; }
    .gallery-next{ right:8px; }

    /* ê²€ìƒ‰ íŒ¨ë„ ë³µì‚¬ ì•„ì´ì½˜ ë²„íŠ¼ */
    .search-panel.overlay .copy-btn{
      flex:0 0 22px; width:22px; height:22px;
      border:0; background:transparent; padding:0; margin-left:4px;
      display:inline-flex; align-items:center; justify-content:center;
      color: var(--BOOMAP_KEY); cursor:pointer; opacity:.9;
    }
    .search-panel.overlay .copy-btn:hover{ opacity:1; }
    .search-panel.overlay .copy-btn svg{ display:block; width:16px; height:16px; }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ (ë¶€íŠ¸ë¡œë”) */
    #loading {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: var(--BOOMAP_KEY);   /* â† í‚¤ì»¬ëŸ¬ ì ìš© */
      z-index:999999;
      opacity:1; visibility:visible;
      transition:opacity .35s ease, visibility .35s ease;
      pointer-events:auto;
    }
    #loading.hide{ opacity:0; visibility:hidden; }

    /* ë¡œê³ /í…ìŠ¤íŠ¸ */
    #loading .boot{ text-align:center; user-select:none; }
    #loading .logo { 
      font-size: 32px; 
      font-weight: 900; 
      color: #ffffff;
      line-height: 1.1; 
    }
    #loading .logo .letters{ letter-spacing:.14em; }   /* ê¸€ì ê°„ê²©ì€ ì—¬ê¸°ë§Œ ì ìš© */
    #loading .logo .letters span {
      display: inline-block;
      animation: boing 1.05s ease-in-out infinite;
      transform-origin: 70% 100%;
      text-shadow: 0 6px 16px rgba(0,0,0,.12);
      color: #ffffff;
    }
    #loading .logo .letters span:nth-child(1){ animation-delay:0.00s }
    #loading .logo .letters span:nth-child(2){ animation-delay:0.06s }
    #loading .logo .letters span:nth-child(3){ animation-delay:0.12s }
    #loading .logo .letters span:nth-child(4){ animation-delay:0.18s }
    #loading .logo .letters span:nth-child(5){ animation-delay:0.24s }
    #loading .logo .letters span:nth-child(6){ animation-delay:0.30s }

    /* by PS : ì ˆë°˜ í¬ê¸°, ê°„ê²© ì¶•ì†Œ */
    #loading .logo .by {
      font-size: .5em; 
      font-weight: 700; 
      color: #374151;        
      margin-left: .15em; 
      letter-spacing: 0; 
      vertical-align: baseline;
    }

    /* í†µí†µ íŠ€ëŠ” ëŠë‚Œ */
    @keyframes boing{
      0%,60%,100%{ transform:translateY(0) scale(1) rotate(0deg); }
      30%{ transform:translateY(-10px) scale(1.06) rotate(-2deg); }
    }

    /* ëª¨ë°”ì¼ */
    .mobile-topbar { display:none; }
    @media (max-width: 768px) {
      #app { grid-template-columns:1fr; }
      #sidebar {
        border-right: 1px solid #e5e7eb;
        padding: 0 10px 10px;
        overflow: auto;
        background: #76679E;   /* BOOMAP_KEY ìƒ‰ìƒ */
      }
      #sidebar.open { transform:translateX(0); }
      #map { height:100vh; min-height:100vh; }
      .mobile-topbar { display:block; position:fixed; top:8px; left:8px; z-index:1100; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    }
  </style>
</head>
<body>
  <div id="loading" aria-live="polite">
    <div class="boot" role="status" aria-label="BOOMAP ë¡œë”©ì¤‘">
      <div class="logo">
        <span class="letters">
          <span>B</span><span>O</span><span>O</span><span>M</span><span>A</span><span>P</span>
        </span><span class="by">by PS</span>
      </div>
    </div>
  </div> 
  <div id="app">
    <div id="sidebar" aria-label="í•„í„° íŒ¨ë„">
      <div class="sidebar-header">
        <img src="https://raw.githubusercontent.com/PS-Decoding/BOOMAP/f579bea613e01a3139bbbee6429e578ad17dc2a6/BOOMAP_icon/web/icon-192.png"
            alt="BOOMAP ë¡œê³ "
            style="height:40px; object-fit:contain;">
      </div>
      <div class="filter-group">
        <div class="group-title">ê±°ë˜ìœ í˜•</div>
        <div class="rowline typechips" role="group" aria-label="ê±°ë˜ìœ í˜• ì„ íƒ">
          <button id="chipAll"     class="type-chip k-all"     aria-pressed="true"  data-type="ALL">ì „ì²´</button>
          <button id="chipSale"    class="type-chip k-sale"    aria-pressed="false" data-type="ë§¤ë§¤">ë§¤ë§¤</button>
          <button id="chipJeonse"  class="type-chip k-jeonse"  aria-pressed="false" data-type="ì „ì„¸">ì „ì„¸</button>
          <button id="chipMonthly" class="type-chip k-monthly" aria-pressed="false" data-type="ì›”ì„¸">ì›”ì„¸</button>
        </div>
      </div>

      <div class="filter-group">
        <div class="group-title">ê°€ê²© ë²”ìœ„(ë§Œì›)</div>
        <div class="rowline">
          <input id="minPrice" type="number" class="w-110" placeholder="ë³´ì¦ê¸ˆ/ë§¤ë§¤ ìµœì €">
          <input id="maxPrice" type="number" class="w-110" placeholder="ë³´ì¦ê¸ˆ/ë§¤ë§¤ ìµœê³ ">
        </div>
        <div class="rowline" style="margin-top:6px;">
          <input id="minRent" type="number" class="w-110" placeholder="ì›”ì„¸ ìµœì €">
          <input id="maxRent" type="number" class="w-110" placeholder="ì›”ì„¸ ìµœê³ ">
        </div>
      </div>

      <div class="filter-group">
        <div class="group-title">ì¶”ê°€ í•„í„°</div>
        <div class="rowline">
          <select id="loanFilter" class="w-110">
            <option value="">ëŒ€ì¶œ(ì „ì²´)</option>
            <option value="general">ì¼ë°˜</option>
            <option value="gov">ì •ë¶€</option>
            <option value="HUG">HUG</option>
            <option value="HF">HF</option>
            <option value="LH">LH</option>
            <option value="check">í™•ì¸í•„ìš”</option>
            <option value="no">ë¶ˆê°€</option>
          </select>
          <select id="roomFilter" class="w-110">
            <option value="">ë°©ê°œìˆ˜(ì „ì²´)</option>
            <option value="1">ì›ë£¸</option>
            <option value="2">íˆ¬ë£¸</option>
            <option value="3+">ì“°ë¦¬ë£¸+</option>
          </select>
        </div>
        <div class="rowline" style="margin-top:6px;">
          <select id="parkingFilter" class="w-110">
            <option value="">ì£¼ì°¨(ì „ì²´)</option>
            <option value="yes">ì£¼ì°¨ ê°€ëŠ¥</option>
            <option value="no">ì£¼ì°¨ ë¶ˆê°€</option>
          </select>
          <select id="petsFilter" class="w-110">
            <option value="">ë°˜ë ¤(ì „ì²´)</option>
            <option value="yes">ë°˜ë ¤ ê°€ëŠ¥</option>
            <option value="no">ë°˜ë ¤ ë¶ˆê°€</option>
          </select>
        </div>
      </div>

      <div class="stat">
        <span id="count">0</span>ê°œ í‘œì‹œ ì¤‘ <span class="dim" id="ovStat" style="margin-left:6px;"></span>
      </div>
      <div id="list" style="margin-top:6px;"></div>
    </div>

    <div id="map" aria-label="ì§€ë„">
      <!-- ì¢Œìƒë‹¨ ê²€ìƒ‰ FAB -->
      <div id="mapSearchDock" class="map-searchdock">
        <div id="fabSearch" class="fabsearch">
          <span id="fabHandle" class="icon" aria-hidden="true"></span>
          <input id="addrInput" type="search" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ë„ë¡œëª…/ì§€ë²ˆ)" />
          <button id="addrCollapse" class="btn-collapse" title="ì ‘ê¸°">â€¹</button>
        </div>
        <div id="searchHint" class="search-hint" role="alert" aria-live="polite">ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
      </div>

      <!-- ì˜¤ë¥¸ìª½-í•˜ë‹¨: ë ˆì´ì–´ ë„í¬ -->
      <div id="layerDockBR" class="map-layerbr">
        <!-- ë ˆì´ì–´ í† ê¸€ -->
        <div class="layer-wrap">
          <button id="layerFab" class="layer-fab" title="ë ˆì´ì–´ í† ê¸€" aria-label="ë ˆì´ì–´ í† ê¸€"></button>
          <!-- ğŸ‘‡ ì™¼ìª½ìœ¼ë¡œ 1ì¤„ íŒ¨ë„ -->
          <div id="layerPanel" class="layer-panel hidden" role="dialog" aria-label="ì§€ë„ ë ˆì´ì–´">
            <button id="btnMoa"  class="btn-layer moa"  aria-pressed="true">ëª¨ì•„</button>
            <button id="btnFast" class="btn-layer fast" aria-pressed="true">ì‹ ì†</button>
          </div>
        </div>
        <!-- ë²”ë¡€ í† ê¸€ -->
        <div class="legend-wrap" style="margin-top:10px;">
          <button id="legendFab" class="legend-fab" title="ë²”ë¡€ ë³´ê¸°" aria-label="ë²”ë¡€ ë³´ê¸°"></button>
          <!-- ğŸ‘‡ ì™¼ìª½ìœ¼ë¡œ ë²”ë¡€ íŒ¨ë„ -->
          <div id="legendPanel" class="legend-panel hidden" role="dialog" aria-label="ê±°ë˜ìœ í˜• ë²”ë¡€">
            <span class="badge red">ë§¤ë§¤</span>
            <span class="badge blue">ì „ì„¸</span>
            <span class="badge green">ì›”ì„¸</span>
          </div>
        </div>
      </div>

      <!-- ìš°ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë¬¶ìŒ -->
      <div id="ctrlDockTR"
        style="position:absolute; right:14px; top:12px; z-index:12000;
        display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <!-- ë§µíƒ€ì…: ë°˜ë°˜ ì„¸ê·¸ë¨¼íŠ¸ -->
        <div id="segMapType" class="ctrl maptype segmented is-road" role="tablist" aria-label="ë§µ íƒ€ì… ì„ íƒ">
          <button id="segRoad" class="seg" role="tab" aria-selected="true">ì¼ë°˜</button>
          <button id="segSky"  class="seg" role="tab" aria-selected="false">ìŠ¤ì¹´ì´ë·°</button>
        </div>

        <!-- ì¤Œ: ì„¸ë¡œ ë¼ìš´ë“œ ë°•ìŠ¤ (+ / íŠ¸ë™ / â€“) -->
        <div class="ctrl zoom nv-full" aria-label="ì§€ë„ í™•ëŒ€/ì¶•ì†Œ">
          <button id="zoomPlus" class="zbtn sym" aria-label="í™•ëŒ€">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="zdiv"></div>
          <div id="zoomCenter" class="zcenter">
            <div id="zoomGuide" class="zguide"></div>
            <div class="zbar">
              <div id="zoomFill" class="zfill"></div>
              <i id="zoomThumb" class="zthumb" aria-hidden="true"></i>
            </div>
          </div>
          <div class="zdiv"></div>
          <button id="zoomMinus" class="zbtn sym" aria-label="ì¶•ì†Œ">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- ì§€ë„ ìƒë‹¨ íˆ´ë°”(í˜„ì¬ ìœ„ì¹˜) -->
      <div id="mapBottombar" class="map-bottombar" style="position:absolute; top:12px; left:50%; transform:translateX(-50%); z-index:12000; display:flex; gap:10px; pointer-events:none;">
        <div id="locBadge" class="loc-badge" style="pointer-events:auto; background:#ffffffcc; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; color:#374151; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,.06); white-space:nowrap;" title="í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ í–‰ì •êµ¬ì—­">-</div>
      </div>
    </div>
  </div>

  <button class="mobile-topbar" id="btnMenu" aria-label="í•„í„° ì—´ê¸°">â˜° í•„í„°</button>

  <script>
    /* ========== [A] ì „ì—­/í—¬í¼ ========== */
    const $  = (id) => document.getElementById(id);
    const on = (el, type, handler) => el && el.addEventListener(type, handler);
    
    function _clamp(v, min, max){ return Math.min(Math.max(v, min), max); }
    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    let data = [];
    let map = null, geocoder = null, clusterer = null;
    let searchPinOv = null, searchPanelOv = null;
    let activeRow = null, activeCard = null;

    let _searchHintTimer = null;
    function showSearchHint(msg){
      const el = $("searchHint");
      if(!el) return;
      el.textContent = msg || "ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
      el.classList.add("show");
      clearTimeout(_searchHintTimer);
      _searchHintTimer = setTimeout(()=> el.classList.remove("show"), 1600); // 1.6ì´ˆ ë’¤ í˜ì´ë“œì•„ì›ƒ
    }

    const LAYER_STATE = { moa: true, fast: true };

    let moaPolys = [], fastPolys = [], planInfoWins = [];
    let planHoverOverlay = null;

    let markerPills = [];
    let spiderMarkers = [], spiderLegs = [], spiderCards = [], spiderPills = [];
    const spiderAnimating = new Set();
    const spiderOpened    = new Set();

    const UNCLUSTER_NEAR_LEVEL = 3;
    const SAME_SPIDER_LEVEL = 5;
    const NEAR_SPIDER_LEVEL = 3;

    /* ===== ë¶€íŠ¸ ì˜¤ë²„ë ˆì´ ìƒíƒœ ===== */
    const BOOT = { listings:false, overlays:false, tiles:false, done:false };

    function hideBoot(){
      const el = $("loading"); if(!el) return;
      el.classList.remove("show");
      el.classList.add("hide");    // í˜ì´ë“œ ì•„ì›ƒ
      // ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ë©´ ì™„ì „íˆ display:none
      setTimeout(()=>{ el.style.display = "none"; }, 380);
    }

    function bootCheck(){
      if(BOOT.done) return;
      if(BOOT.listings && BOOT.overlays && BOOT.tiles){
        BOOT.done = true;
        hideBoot();
      }
    }

    // ì•ˆì „ì¥ì¹˜: ë§Œì•½ ë­”ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ 8ì´ˆ í›„ì—ëŠ” ìë™ í•´ì œ
    setTimeout(()=>{ if(!BOOT.done) hideBoot(); }, 8000);

    /* ===== Hover z-index helpers ===== */
    function bindHoverZForMarker(marker, hiZ){
      if(!marker) return;
      if (marker.__baseZ == null){
        try{ marker.__baseZ = (marker.getZIndex && marker.getZIndex()) || 0; }catch(_){ marker.__baseZ = 0; }
      }
      kakao.maps.event.addListener(marker, 'mouseover', function(){ try{ marker.setZIndex(hiZ); }catch(_){} });
      kakao.maps.event.addListener(marker, 'mouseout',  function(){ try{ marker.setZIndex(marker.__baseZ); }catch(_){} });
    }

    function bindHoverZForOverlay(overlay, contentEl, hiZ, baseZ){
      if(!overlay || !contentEl) return;
      overlay.__baseZ = (baseZ!=null ? baseZ : ((overlay.getZIndex && overlay.getZIndex()) || 0));
      function _up(){   try{ overlay.setZIndex(hiZ); }catch(_){} }
      function _down(){ try{ overlay.setZIndex(overlay.__baseZ); }catch(_){} }
      contentEl.addEventListener('mouseenter', _up);
      contentEl.addEventListener('mouseleave', _down);
    }

    async function copyTextToClipboard(text){
      try{
        if (navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          return true;
        } else {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
          document.body.appendChild(ta); ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        }
      }catch(_){ return false; }
    }

    /* === [WARM] í”„ë¦¬íŒ¨ì¹˜ ìƒíƒœ/ì„¤ì • === */
    const WARM = {
      maxIds: 16,            // í•œ ë²ˆì— ì›Œë°í•  í´ë” ê°œìˆ˜ ìƒí•œ
      debounceMs: 400,       // ë””ë°”ìš´ìŠ¤ ì§€ì—°
      timer: null,
      lastKey: ""            // ì§ì „ í˜¸ì¶œ í‚¤(ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
    };
        
    /* ===== ì£¼ì†Œ ì •ê·œí™”(ê°„ë‹¨ í‚¤) ===== */
    function normalizeKRAddr(raw){
      if(!raw) return "";
      let s = String(raw)
        .replace(/^ëŒ€í•œë¯¼êµ­\s*/,'')           // "ëŒ€í•œë¯¼êµ­ " ì œê±°
        .replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ/g, 'ì‹œ')      // ì„œìš¸íŠ¹ë³„ì‹œ â†’ ì„œìš¸ì‹œ
        .replace(/\s+/g,'')                   // ê³µë°± ì œê±°
        .replace(/[.,Â·\-â€“â€”~]/g,'');           // êµ¬ë‘ì  ì œê±°
      // ë™/ë¡œ/ê¸¸ + ë²ˆì§€ íŒ¨í„´ì„ ìµœëŒ€í•œ ì‚´ë¦¼ (ì˜ˆ: ë©´ëª©ë™45834, ê²¸ì¬ë¡œ30ê¸¸42 ë“±)
      // í˜¸ìˆ˜(B101í˜¸ ê°™ì€)ëŠ” ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë¹„êµ ê°•í™”
      return s.toLowerCase();
    }

    function isSameNormalizedAddress(a, b){
      const na = normalizeKRAddr(a);
      const nb = normalizeKRAddr(b);
      return !!na && na === nb;
    }

    function findListingsByNormalizedAddress(addrCandidates){
      // addrCandidates: [ë„ë¡œëª…ì£¼ì†Œ, ì§€ë²ˆì£¼ì†Œ, ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë¬¸] ê°™ì€ ì—¬ëŸ¬ í›„ë³´ ë°°ì—´
      const norms = (addrCandidates||[])
        .filter(Boolean)
        .map(normalizeKRAddr)
        .filter(Boolean);
      if(!norms.length) return [];

      // data = ì „ì—­ ë§¤ë¬¼ ë°°ì—´ (ì´ë¯¸ ìˆìŒ)
      return data.filter(row=>{
        const a = row && row.address ? normalizeKRAddr(row.address) : "";
        if(!a) return false;
        // í›„ë³´ ì¤‘ í•˜ë‚˜ì™€ ì¼ì¹˜í•˜ë©´ í†µê³¼
        return norms.includes(a);
      });
    }

    /* ========== ê³µí†µ ìœ í‹¸/í¬ë§· ========== */
    function normalizeNumber(x){
      if(x===null||x===undefined) return null;
      if(typeof x==="number") return x;
      const s=String(x).replace(/[^0-9.-]/g,""); if(!s) return null;
      const n=Number(s); return isFinite(n)?n:null;
    }
    function formatKRWMan(value){
      if(value===null||value===undefined||value==="")return "-";
      const n=Number(value); if(isNaN(n))return String(value);
      if(n>=10000){ const eok=Math.floor(n/10000); const man=n%10000; return man?(eok+"ì–µ "+man.toLocaleString()+"ë§Œ"):(eok+"ì–µ"); }
      return n.toLocaleString()+"ë§Œ";
    }
    function formatManCompact(n){
      const x = normalizeNumber(n);
      if(x==null) return "-";
      if(x >= 10000){
        let v = (x/10000).toFixed(1);
        if(/\.0$/.test(v)) v = v.slice(0,-2);
        return v + 'ì–µ';
      }
      return String(Math.round(x));
    }
    function normType(t){
      const s=String(t||"");
      if(/ë°˜ì „ì„¸|ë°˜ì „/.test(s)) return "ì›”ì„¸";
      if(/ì›”ì„¸/.test(s))return "ì›”ì„¸";
      if(/ì „ì„¸/.test(s))return "ì „ì„¸";
      if(/ë§¤ë§¤/.test(s))return "ë§¤ë§¤";
      return s.trim();
    }
    function typeCssClass(t){
      const nt = normType(t);
      if(nt==="ë§¤ë§¤") return "sale";
      if(nt==="ì „ì„¸") return "jeonse";
      if(nt==="ì›”ì„¸") return "monthly";
      return "jeonse";
    }
    function typeToken(type){
      const nt = normType(type);
      if(nt==="ë§¤ë§¤") return "red";
      if(nt==="ì „ì„¸") return "blue";
      if(nt==="ì›”ì„¸") return "green";
      return "blue";
    }
    function colorVar(kind){
      if(kind === "red")   return cssVar("--RED");
      if(kind === "blue")  return cssVar("--BLUE");
      if(kind === "green") return cssVar("--GREEN");
      return cssVar("--BLUE");
    }
    function ynState(val){
      const s=String(val==null?"":val).trim();
      if(!s) return "unknown";
      if(/^(ê°€ëŠ¥|O|Y|YES|TRUE|OK|ê°€ëŠ¥âœ…)$/i.test(s))return "yes";
      if(/^(ë¶ˆê°€|X|N|NO|FALSE)$/i.test(s))return "no";
      return "unknown";
    }
    function ynChip(val){
      const st=ynState(val);
      if(st==="yes")return '<span class="chip ok">ê°€ëŠ¥</span>';
      if(st==="no")return '<span class="chip no">ë¶ˆê°€</span>';
      return '<span class="chip info">ì •ë³´ì—†ìŒ</span>';
    }
    function loanState(val){
      const s=String(val==null?"":val).trim();
      if(!s) return {code:"unknown",label:"ì •ë³´ì—†ìŒ","class":"info"};
      if(/ë¶ˆê°€/.test(s)) return {code:"no",label:"ë¶ˆê°€","class":"no"};
      if(/í™•ì¸/.test(s)) return {code:"check",label:"í™•ì¸í•„ìš”","class":"info"};
      if(/ì¼ë°˜/.test(s)) return {code:"general",label:"ì¼ë°˜","class":"ok"};
      if(/ì •ë¶€/.test(s)) return {code:"gov",label:"ì •ë¶€","class":"ok"};
      if(/^HUG$/i.test(s)||/HUG/i.test(s)) return {code:"HUG",label:"HUG","class":"ok"};
      if(/^HF$/i.test(s)||/HF/i.test(s))   return {code:"HF",label:"HF","class":"ok"};
      if(/^LH$/i.test(s)||/LH/i.test(s))   return {code:"LH",label:"LH","class":"ok"};
      return {code:"unknown",label:s,"class":"info"};
    }
    function loanChip(val){ const st=loanState(val); return '<span class="chip '+st["class"]+'">'+st.label+'</span>'; }

    function compactPriceLine(row){
      const t = normType(row.type);
      const d = formatManCompact(row.depositOrPrice);
      if(t==="ì›”ì„¸"){
        const r = formatManCompact(row.rent);
        return d + '/' + r;
      }
      return d;
    }

    // ë¸Œëœë“œ í‚¤ì›Œë“œ: 'ì•„íŒŒíŠ¸'ê°€ ì—†ì–´ë„ ë‹¨ì§€ ê°ì§€ìš©
    const APT_BRAND_RE =
      /(ì•„ì´íŒŒí¬|ìì´|í‘¸ë¥´ì§€ì˜¤|ë˜ë¯¸ì•ˆ|íìŠ¤í…Œì´íŠ¸|ë¡¯ë°ìºìŠ¬|ìºìŠ¬|eí¸í•œì„¸ìƒ|ë”ìƒµ|ì„¼íŠ¸ë ˆë¹Œ|ìœ„ë¸Œ|í•˜ëŠ˜ì±„|í¬ë ˆë‚˜|ë¦¬ì„¼ì¸ |íŠ¸ë¦¬ë§ˆì œ|íŒŒí¬ë·°|ë¦¬ë²„ë·°|ë§ˆì ¤ë€\d*|ì„¼íŠ¸ëŸ´ì•„ì´íŒŒí¬|ì„¼íŠ¸ëŸ´íŒŒí¬)/i;

    // ì•„íŒŒíŠ¸ ì—¬ë¶€: houseType/type/address/ë¸Œëœë“œë¡œ íŒë‹¨
    function isApartment(row){
      const t = String(row.houseType||row.type||"");
      if (/ì•„íŒŒíŠ¸/i.test(t)) return true;
      const a = String(row.address||"");
      return /ì•„íŒŒíŠ¸/i.test(a) || APT_BRAND_RE.test(a);
    }

    /**
     * ì£¼ì†Œì—ì„œ "í–‰ì •êµ¬ì—­/ì§€ë²ˆ/ë„ë¡œëª…"ì„ ì•ì—ì„œ ì œê±°í•˜ê³ 
     * ì•„íŒŒíŠ¸ ë‹¨ì§€ëª…~ë™/í˜¸ ê°™ì€ ë’·ë¶€ë¶„ë§Œ ë‚¨ê¸´ ë¬¸ìì—´ì„ ë¦¬í„´.
     *  - ì§€ë²ˆ: "...ë™ (ìˆ«ì|ìˆ«ì-ìˆ«ì)"
     *  - ë„ë¡œëª…: "(...ë¡œ|...ê¸¸|...ë¡œìˆ«ìê¸¸) [ìˆ«ì|ìˆ«ì-ìˆ«ì]"
     *  - ìœ„ê°€ ì—†ìœ¼ë©´ í–‰ì •êµ¬ì—­ í† í°(ì‹œ/êµ°/êµ¬/ë™/ì/ë©´/ë¦¬/ê°€ ë“±)ë§Œ ì­‰ ë‚ ë¦¬ê³  ë‚¨ì€ ê²ƒ ì‚¬ìš©
     */
    function aptTailFromAddress(addr){
      const s = String(addr||"").trim();
      if (!s) return "";

      const tokens = s.split(/\s+/);

      const HOUSE_NO_RE  = /^\d+(?:-\d+)?$/;
      const ROAD_END_RE  = /(?:ë¡œ|ê¸¸)$/;        // â€¦ë¡œ, â€¦ê¸¸
      const ROAD_MIX_RE  = /ë¡œ\d*ê¸¸$/;          // ê²¸ì¬ë¡œ30ê¸¸ ê°™ì€ 1í† í°
      const DONG_RE      = /ë™$/;               // â€¦ë™ (í–‰ì •ë™/ë²•ì •ë™/ë‹¨ì§€ë™ ëª¨ë‘ ì¼ë‹¨ í›„ë³´)
      const ADMIN_END_RE = /(ì‹œ|êµ°|êµ¬|ë„|ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ|ìì¹˜êµ¬|ë™|ì|ë©´|ë¦¬|ê°€)$/;

      const N = tokens.length;

      // 1) ë„ë¡œëª… íŒ¨í„´ ì•ë¶€ë¶„ ì œê±°
      //    - "ê²¸ì¬ë¡œ30ê¸¸ 42 â€¦" â†’ 'ê²¸ì¬ë¡œ30ê¸¸' í† í° + ë‹¤ìŒ ìˆ«ì í† í°ê¹Œì§€ ê±´ë„ˆë›°ê³  tail ì‹œì‘
      //    - "...ë¡œ/â€¦ê¸¸" + ìˆ«ì(ë˜ëŠ” ìˆ«ì-ìˆ«ì)
      for (let k=0; k<N; k++){
        const tk = tokens[k];
        // í•œ í† í°ì´ 'ë¡œìˆ«ìê¸¸' í˜•íƒœì´ê±°ë‚˜ 'â€¦ë¡œ/â€¦ê¸¸'ë¡œ ëë‚˜ë©´ ë„ë¡œëª…ìœ¼ë¡œ ë´„
        if (ROAD_MIX_RE.test(tk) || ROAD_END_RE.test(tk)){
          let j = k + 1;
          // ë’¤ì— ë²ˆì§€ìˆ«ì(ì˜ˆ: 42, 42-1)ê°€ ìˆìœ¼ë©´ ê°™ì´ ì œê±°
          if (j < N && HOUSE_NO_RE.test(tokens[j])) j++;
          // ë„ë¡œëª… ë¸”ë¡ì„ ë°œê²¬í–ˆìœ¼ë‹ˆ ê·¸ ë’¤ê°€ tail
          return tokens.slice(j).filter((t,i)=> !(i===0 && HOUSE_NO_RE.test(t))).join(' ').trim();
        }
      }

      // 2) ì§€ë²ˆ íŒ¨í„´ ì•ë¶€ë¶„ ì œê±°
      //    - "...ë™ 123-45 â€¦" â†’ 'â€¦ë™' + ë‹¤ìŒ ìˆ«ì(ë˜ëŠ” ìˆ«ì-ìˆ«ì)ê¹Œì§€ ê±´ë„ˆë›°ê³  tail ì‹œì‘
      for (let k=0; k<N; k++){
        const tk = tokens[k];
        if (DONG_RE.test(tk)){
          let j = k + 1;
          if (j < N && HOUSE_NO_RE.test(tokens[j])) j++;
          return tokens.slice(j).filter((t,i)=> !(i===0 && HOUSE_NO_RE.test(t))).join(' ').trim();
        }
      }

      // 3) ìœ„ ë‘˜ ë‹¤ ëª» ì°¾ì€ ê²½ìš°:
      //    - ì•ìª½ í–‰ì •êµ¬ì—­(â€¦ì‹œ/êµ°/êµ¬/ë™/ì/ë©´/ë¦¬/ê°€) í† í°ì€ ë‚ ë¦¬ê³  ì²« ë¹„-í–‰ì •êµ¬ì—­ í† í°ë¶€í„° ì‚¬ìš©
      let start = 0;
      while (start < N && ADMIN_END_RE.test(tokens[start])) start++;
      return tokens.slice(start).filter((t,i)=> !(i===0 && HOUSE_NO_RE.test(t))).join(' ').trim();
    }

    /** ì•„íŒŒíŠ¸ í‘œê¸° ì „ìš©: ê·œì¹™ ì ìš© */
    function compactAptTail(row){
      const addr = String(row.address||"");
      const tail = aptTailFromAddress(addr);
      // 'ì•„íŒŒíŠ¸' ë‹¨ì–´ëŠ” ë³´ê¸°ë§Œ ì§€ì €ë¶„í•˜ë‹ˆ ë¹¼ê³  ì‹¶ìœ¼ë©´ ë‹¤ìŒ ì¤„ ì£¼ì„ í•´ì œ:
      // return tail.replace(/\s*ì•„íŒŒíŠ¸\s*/g, ' ').replace(/\s+/g,' ').trim();
      return tail;
    }

    /** ë¦¬ìŠ¤íŠ¸/ì¹´ë“œì—ì„œ ì‚¬ìš©í•  í†µí•© ë¼ë²¨ */
    function compactAptLabel(row){
      return isApartment(row) ? compactAptTail(row) : (row.address||"");
    }

    /* ========== ì§€ë„ ì´ë™ ìœ í‹¸ ========== */
    function onceIdle(fn){
      const h = kakao.maps.event.addListener(map, 'idle', function _(){
        kakao.maps.event.removeListener(map, 'idle', _);
        fn && fn();
      });
      return h;
    }
    function smoothPanTo(latLng){ try { map.panTo(latLng); } catch(_) { map.setCenter(latLng); } }
    function smoothZoomTo(targetLevel, anchor){
      const cur = map.getLevel();
      if (typeof targetLevel !== 'number' || targetLevel === cur) return;
      try { map.setLevel(targetLevel, { anchor: anchor || map.getCenter(), animate: true }); return; } catch(_){}
      let now = cur;
      (function step(){
        if (now === targetLevel) return;
        now += (targetLevel > now ? 1 : -1);
        try { if (anchor) map.setLevel(now, { anchor }); else map.setLevel(now); } catch(_) { map.setLevel(now); }
        if (now !== targetLevel) setTimeout(step, 120);
      })();
    }
    function smoothPanZoomTo(latLng, targetLevel){
      if (latLng) { smoothPanTo(latLng); onceIdle(() => smoothZoomTo(targetLevel, latLng)); }
      else { smoothZoomTo(targetLevel); }
    }
    function nudgeIfEdge(pos, opts){
      try{
        const cfg = Object.assign({ safePct:{top:.35,right:.2,bottom:.16,left:.2}, extraPx:{top:220,side:70,bottom:0}, minShiftPx:10 }, opts||{});
        const rect = $("map").getBoundingClientRect();
        const proj = map.getProjection();
        const pt   = proj.containerPointFromCoords(pos);
        const safe = {
          left:   Math.round(rect.width  * cfg.safePct.left),
          right:  Math.round(rect.width  * cfg.safePct.right),
          top:    Math.round(rect.height * cfg.safePct.top),
          bottom: Math.round(rect.height * cfg.safePct.bottom)
        };
        let dx=0, dy=0;
        if (pt.x < safe.left) dx = -(safe.left - pt.x + cfg.extraPx.side);
        else if (pt.x > rect.width - safe.right) dx = +(pt.x - (rect.width - safe.right) + cfg.extraPx.side);
        if (pt.y < safe.top) dy = -(safe.top - pt.y + cfg.extraPx.top);
        else if (pt.y > rect.height - safe.bottom) dy = +(pt.y - (rect.height - safe.bottom) + (cfg.extraPx.bottom||0));
        if (Math.abs(dx) < cfg.minShiftPx) dx = 0;
        if (Math.abs(dy) < cfg.minShiftPx) dy = 0;
        if (dx || dy) map.panBy(dx, dy);
      }catch(e){}
    }

    /* ========== ì£¼ì†Œ/í–‰ì •êµ¬ì—­ ì¡°íšŒ ========== */
    function fetchRoadJibunByLatLng(latlng, cb){
      if (!geocoder || !latlng){ cb && cb(null,null); return; }
      geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(res, status){
        if (status !== kakao.maps.services.Status.OK || !res?.length){ cb && cb(null, null); return; }
        const r0 = res[0] || {};
        const road  = (r0.road_address && r0.road_address.address_name) || null;
        const jibun = (r0.address       && r0.address.address_name)       || null;
        cb && cb(road, jibun);
      });
    }
    function locTextByLevel(info, level){
      if(!info) return "-";
      if(level <= 5) return info.region_3depth_name || info.region_2depth_name || info.region_1depth_name || "-";
      if(level <= 8) return info.region_2depth_name || info.region_1depth_name || "-";
      return info.region_1depth_name || "-";
    }
    function updateLocBadge(){
      try{
        const c = map.getCenter();
        geocoder.coord2RegionCode(c.getLng(), c.getLat(), function(res, status){
          if(status !== kakao.maps.services.Status.OK || !res?.length) return;
          const info = res.find(r=>r.region_type==="B") || res[0];
          const txt = locTextByLevel(info, map.getLevel());
          const el = $("locBadge"); if(el) el.textContent = txt || "-";
        });
      }catch(_){}
    }

    /* ========== ê²€ìƒ‰ UI(ë‹¨ì¼í™”) ========== */
    function clearSearchMarker(){ try{ if (searchPinOv){ searchPinOv.setMap(null); searchPinOv = null; } }catch(_){ } }
    function closeSearchOverlay(){ if (searchPanelOv){ try{ searchPanelOv.setMap(null);}catch(_){ } searchPanelOv=null; } clearSearchMarker(); $("fabSearch")?.classList.remove('searched'); }
    function openSearchOverlayAtPin(headerText, road, jibun){
      if (!searchPinOv) return;
      if (searchPanelOv){ try{ searchPanelOv.setMap(null);}catch(_){ } searchPanelOv = null; }

      const el = document.createElement('div');
      el.className = 'search-panel overlay';
      el.innerHTML =
        '<div class="head">'+
        '  <i class="icon" aria-hidden="true"></i>'+
        '  <div class="title">'+(headerText||'-')+'</div>'+
        '  <button class="panel-close" title="ë‹«ê¸°">Ã—</button>'+
        '</div>'+
        '<div class="body">'+
        // â–¼ ê° í–‰ ì˜¤ë¥¸ìª½ì— ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€
        '  <div class="kv"><span class="k">ë„</span>'+
        '    <span class="v" id="roadVal">'+(road||'-')+'</span>'+
        '    <button class="copy-btn" id="copyRoad" title="ë„ë¡œëª… ì£¼ì†Œ ë³µì‚¬" aria-label="ë„ë¡œëª… ì£¼ì†Œ ë³µì‚¬">'+
        "      <svg viewBox='0 0 24 24' aria-hidden='true'><g fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='9' y='9' width='10' height='10' rx='2'/><path d='M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1'/></g></svg>"+
        '    </button>'+
        '  </div>'+
        '  <div class="kv"><span class="k">ì§€</span>'+
        '    <span class="v" id="jibunVal">'+(jibun||'-')+'</span>'+
        '    <button class="copy-btn" id="copyJibun" title="ì§€ë²ˆ ì£¼ì†Œ ë³µì‚¬" aria-label="ì§€ë²ˆ ì£¼ì†Œ ë³µì‚¬">'+
        "      <svg viewBox='0 0 24 24' aria-hidden='true'><g fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='9' y='9' width='10' height='10' rx='2'/><path d='M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1'/></g></svg>"+
        '    </button>'+
        '  </div>'+
        '</div>';

      el.addEventListener('click', e=>e.stopPropagation());
      el.querySelector('.panel-close').addEventListener('click', e=>{
        e.stopPropagation(); closeSearchOverlay();
      });

      // â–¼ ë³µì‚¬ ë²„íŠ¼ ë°”ì¸ë”©
      const roadTxt  = road  || '';
      const jibunTxt = jibun || '';
      const btnRoad  = el.querySelector('#copyRoad');
      const btnJibun = el.querySelector('#copyJibun');

      function bindCopy(btn, txt){
        if(!btn) return;
        btn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          if(!txt || txt === '-'){ showSearchHint('ë³µì‚¬í•  ì£¼ì†Œê°€ ì—†ì–´ìš”.'); return; }
          const ok = await copyTextToClipboard(txt);
          showSearchHint(ok ? 'ë³µì‚¬ë¨' : 'ë³µì‚¬ ì‹¤íŒ¨');
        });
      }
      bindCopy(btnRoad,  roadTxt);
      bindCopy(btnJibun, jibunTxt);

      searchPanelOv = new kakao.maps.CustomOverlay({
        position: searchPinOv.getPosition(),
        content: el,
        xAnchor: 0.5,
        yAnchor: 1.2,
        zIndex: 12060,
        clickable: true
      });
      searchPanelOv.setMap(map);
      bindHoverZForOverlay(searchPanelOv, el, 12150, 12060);
    }

    function handlePinAndZoom(latlng, label){
      if (searchPinOv){ try{ searchPinOv.setMap(null); }catch(_){ } searchPinOv = null; }
      const pin = document.createElement('div'); pin.className = 'search-pin';
      searchPinOv = new kakao.maps.CustomOverlay({ position: latlng, content: pin, xAnchor:0.5, yAnchor:0.5, zIndex:12050, clickable:false });
      searchPinOv.setMap(map);
      smoothPanZoomTo(latlng, 1);
      $("fabSearch")?.classList.add('searched');
      fetchRoadJibunByLatLng(latlng, (road,jibun)=> openSearchOverlayAtPin(label||'-', road, jibun));
    }

    function normalizeAddress(addr){
      if(!addr) return "";
      return String(addr)
        .replace(/\s+/g, "")
        .replace(/-/g, "")
        .replace(/ë²ˆì§€/g, "")
        .trim();
    }

    // --- ìš°ë¦¬ ë§¤ë¬¼ì—ì„œ ì •ê·œí™” ì£¼ì†Œë¡œ ì¼ì¹˜ í•­ëª© ì°¾ê¸° ---
    // data ë°°ì—´(ë§¤ë¬¼ ëª©ë¡)ê³¼ row.address(Cì—´), row.lat, row.lngë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •
    function findListingByNormalizedAddress(addrNorm){
      if(!addrNorm) return null;
      for(const row of (window.data || [])){
        const ln = normalizeAddress(row.address);
        if(ln && ln === addrNorm) return row;
      }
      return null;
    }

    // --- ë§¤ë¬¼ ì¹´ë“œ(ë˜ëŠ” pill) ì—´ê¸°: row ê¸°ì¤€ ìœ„ì¹˜ë¡œ ì—´ê¸° ---
    function openListingPill(row, fallbackLatLng){
      try{
        const pos = (row && row._marker && row._marker.getPosition)
          ? row._marker.getPosition()
          : (row && typeof row.lat === "number" && typeof row.lng === "number")
            ? new kakao.maps.LatLng(row.lat, row.lng)
            : fallbackLatLng;

        if(!pos) return;
        if(typeof openCardFor === "function"){
          openCardFor(row, pos, true);     // ìƒì„¸ ì¹´ë“œ ì—´ê¸° (+ ì„¼í„°ë¡œ ë¶€ë“œëŸ½ê²Œ)
        }else if(typeof smoothPanZoomTo === "function"){
          smoothPanZoomTo(pos, 1);         // ìµœì†Œí•œ ìœ„ì¹˜ ì´ë™
        }else{
          map && map.setCenter(pos);
        }
      }catch(e){
        console.error("[openListingPill] failed:", e);
      }
    }
    
    // --- ê¸°ë³¸ ë³´ë¼ìƒ‰ í•€/ê²€ìƒ‰ íŒ¨ë„ í‘œì‹œ(ë„¤ê°€ ì“°ë˜ ê¸°ì¡´ í•¨ìˆ˜ ìˆìœ¼ë©´ ê·¸ê±¸ í˜¸ì¶œ) ---
    function placeSearchMarker(latlng, headerLabel){
      // ë„¤ ê¸°ì¡´ ë¡œì§: handlePinAndZoom(latlng, headerLabel) ì„ ì“°ê³  ìˆì—ˆë‹¤ë©´ ê·¸ê±° í˜¸ì¶œ
      if(typeof handlePinAndZoom === "function"){
        handlePinAndZoom(latlng, headerLabel);
        return;
      }
      // í˜¹ì‹œ ì—†ìœ¼ë©´ ìµœì†Œ ë™ì‘
      if(map){ map.setCenter(latlng); }
    }

    // --- ì—¬ê¸°ë¶€í„° ë¬¸ì œì˜ í•¨ìˆ˜: query ì •ì˜í•˜ê³ , ì •ê·œí™” ë§¤ì¹­ â†’ ì„±ê³µ ì‹œ ê¸°ë³¸í•€ ì–µì œ ---
    function runAddressSearch(q){
      // âœ… ì¸ìë¡œ ì˜¤ë©´ ê·¸ê±¸ ì“°ê³ , ì•„ë‹ˆë©´ ì…ë ¥ì°½ ê°’ ì‚¬ìš©
      const inputEl = document.getElementById("addrInput");
      const query = (q != null ? String(q) : (inputEl ? inputEl.value : "")).trim();

      if(!query){
        // íŒíŠ¸ í† ìŠ¤íŠ¸ ì“°ë˜ í•¨ìˆ˜ ìœ ì§€
        if(typeof showSearchHint === "function") showSearchHint("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const g = window.geocoder || new kakao.maps.services.Geocoder();
      g.addressSearch(query, function(res, status){
        if(status === kakao.maps.services.Status.OK && res && res.length){
          const r = res[0];
          const latlng = new kakao.maps.LatLng(Number(r.y), Number(r.x));
          const label = (r.road_address?.address_name) || (r.address?.address_name) || query;

          // ğŸ”¹ ì •ê·œí™” ê¸°ì¤€ í…ìŠ¤íŠ¸(ë„ë¡œëª… ìš°ì„ , ì—†ìœ¼ë©´ ì§€ë²ˆ)
          const normalized = normalizeAddress(
            (r.road_address && r.road_address.address_name) ||
            (r.address && r.address.address_name) ||
            ""
          );

          // ğŸ”¹ ìš°ë¦¬ ë§¤ë¬¼ì—ì„œ ì •ê·œí™”ë¡œ ì •í™• ì¼ì¹˜ ì°¾ê¸° (í•„í„°ì™€ ë¬´ê´€í•˜ê²Œ ì°¾ìŒ)
          const match = findListingByNormalizedAddress(normalized);

          if(match){
            // âœ… ë§¤ë¬¼ ìˆìœ¼ë©´: ê¸°ë³¸ ë³´ë¼í•€/ê²€ìƒ‰íŒ¨ë„ **ì–µì œ**í•˜ê³  ë§¤ë¬¼ ì¹´ë“œ ì—´ê¸°
            openListingPill(match, latlng);

            // ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ì´ â€˜searchedâ€™ ê°™ì€ ê±¸ë¡œ ë°”ë€ŒëŠ” ë¡œì§ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‘ë˜,
            // íŒ¨ë„ì€ ì—´ì§€ ì•Šë„ë¡(= handlePinAndZoom í˜¸ì¶œ ê¸ˆì§€)
            const fab = document.getElementById("fabSearch");
            if(fab) fab.classList.add("searched");
            return; // â† ì¤‘ìš”! ì•„ë˜ ê¸°ë³¸ í•€ ë¡œì§ìœ¼ë¡œ ë‚´ë ¤ê°€ë©´ ì•ˆ ë¨
          }

          // âŒ ë§¤ë¬¼ ì—†ìœ¼ë©´: ê¸°ì¡´ ë™ì‘(ë³´ë¼ìƒ‰ í•€ + ê²€ìƒ‰ íŒ¨ë„)
          placeSearchMarker(latlng, label);
          return;
        }

        // ì£¼ì†Œê²€ìƒ‰ ì‹¤íŒ¨ â†’ ì¥ì†Œê²€ìƒ‰ìœ¼ë¡œ ë³´ì¡°
        const places = new kakao.maps.services.Places();
        places.keywordSearch(query, function(r, s){
          if(s === kakao.maps.services.Status.OK && r && r.length){
            const item = r[0];
            const latlng = new kakao.maps.LatLng(Number(item.y), Number(item.x));
            const label = item.place_name || query;

            // ì¥ì†Œê²€ìƒ‰ì€ ë„ë¡œëª…/ì§€ë²ˆ ë¬¸ìì—´ì´ í™•ì •ì ì´ì§€ ì•Šì•„ â€œì •ê·œí™” ë§¤ë¬¼ ì¼ì¹˜â€ëŠ” ìƒëµ
            placeSearchMarker(latlng, label);
          }else{
            if(typeof showSearchHint === "function") showSearchHint("ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
          }
        }, { size: 3 });
      });
    }

    function initSearchUI(){
      const box = $("fabSearch"), icon = $("fabHandle"), input = $("addrInput"), collapse = $("addrCollapse");
      if(!box || !icon) return;
      function open(){ box.classList.add('open'); input?.removeAttribute('tabindex'); collapse?.removeAttribute('tabindex'); collapse?.setAttribute('aria-hidden','false'); setTimeout(()=> input?.focus(),10); }
      function close(){ box.classList.remove('open'); closeSearchOverlay(); box.classList.remove('searched'); if(input){ input.setAttribute('tabindex','-1'); input.blur(); input.value=''; } if(collapse){ collapse.setAttribute('tabindex','-1'); collapse.setAttribute('aria-hidden','true'); } }
      function isOpen(){ return box.classList.contains('open'); }
      icon.addEventListener('click', (e)=>{ e.stopPropagation(); if (!isOpen()) open(); else input?.focus(); });
      input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const q=(input.value||'').trim(); if(q) runAddressSearch(q); } });
      collapse?.addEventListener('click', (e)=>{ e.stopPropagation(); if(input) input.value=''; close(); });
      box.addEventListener('click', (e)=> e.stopPropagation());
    }
  
      /* ========== ë¦¬ìŠ¤íŠ¸ ë Œë” ========== */
    function renderList(listRows){
      const box=$("list"); box.innerHTML="";
      listRows.forEach(function(row){
        const tLabel=normType(row.type); const cls=typeToken(row.type);
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML =
          '<div><span class="badge '+cls+'">'+(tLabel||"-")+'</span>'+
          '<span class="price">'+formatKRWMan(normalizeNumber(row.depositOrPrice))+'</span>'+
          ((tLabel==="ì›”ì„¸")?(' / <b>ì›”ì„¸ '+formatKRWMan(normalizeNumber(row.rent))+'</b>'):'')+
          '</div>'+
          '<div class="addr">'+(compactAptLabel(row))+'</div>'+
          '<div class="meta">'+(row.sheet||"")+'</div>'+
          '<div class="rowchips">'+
          '  <span class="chip">'+(row.houseType||"ìœ í˜•?")+'</span>'+
          '  <span class="chip">'+(row.area?(row.area+"ã¡"):"ë©´ì ?")+'</span>'+
          '</div>'+
          '<div class="rowchips">'+
          '  <span class="chip">'+((row.floor||row.floor===0)?(row.floor+"ì¸µ"):"ì¸µìˆ˜?")+'</span>'+
          '  <span class="chip">'+((row.rooms!=null&&row.rooms!=="")?("ë°© "+row.rooms):"ë°©?")+'</span>'+
          '  <span class="chip">'+((row.baths!=null&&row.baths!=="")?("ìš•ì‹¤ "+row.baths):"ìš•ì‹¤?")+'</span>'+
          '</div>'+
          '<div class="rowchips">'+
          '  <span>ëŒ€ì¶œ '+loanChip(row.loan)+'</span>'+
          '  <span>ì£¼ì°¨ '+ynChip(row.parking)+'</span>'+
          '  <span>ë°˜ë ¤ '+ynChip(row.pets)+'</span>'+
          '</div>';
        el.onclick=function(){ if(!row._marker) return; openCardFor(row, row._marker.getPosition(), true); };
        box.appendChild(el);
      });
      $("count").textContent=String(listRows.length);
    }

    // ê³µë°±/ê¸°í˜¸ ì •ë¦¬í•´ì„œ 'ì •í™• ì¼ì¹˜' íŒë³„ì„ ì•ˆì •í™”
    function _normalizeAddr(s){
      return String(s||"")
        .replace(/[()\[\]]/g, "")        // ê´„í˜¸ë¥˜ ì œê±°
        .replace(/[ï¼Œ,]+/g, ",")         // ì½¤ë§ˆ í†µì¼
        .replace(/\s+/g, " ")            // ì—°ì† ê³µë°± â†’ 1ì¹¸
        .trim();
    }

    // í† í° ë¶„ë¦¬
    function _splitTokens(s){
      return _normalizeAddr(s).split(" ").filter(Boolean);
    }

    // ìˆ«ì ë˜ëŠ” ìˆ«ì-ìˆ«ì (ì§€ë²ˆ/ë²ˆì§€/ë„ë¡œë²ˆí˜¸)
    const _HOUSE_NO_RE = /^\d+(?:-\d+)?$/;
    // ë„ë¡œëª… í† í° (â€¦ë¡œ / â€¦ê¸¸ / â€¦ëŒ€ë¡œ / â€¦ë¡œìˆ«ìê¸¸)
    const _ROAD_END_RE = /(ë¡œ|ê¸¸|ëŒ€ë¡œ)$/;
    const _ROAD_MIX_RE = /ë¡œ\d*ê¸¸$/;
    // í–‰ì •ë™/ë²•ì •ë™ í† í°
    const _DONG_RE = /ë™$/;
    // ê¼¬ë¦¬(ë™/í˜¸/ì¸µ/ì§€í•˜ì¸µ ë“±) í† í°
    const _TAIL_RE = /(í˜¸|ì¸µ|B\d+í˜¸|ì§€í•˜\d*ì¸µ|ì§€ìƒ\d*ì¸µ)$/i;

    // ì£¼ì†Œì—ì„œ "ê¸°ë³¸ ì§€ë²ˆ" êµ¬ê°„ë§Œ ë‚¨ê¸°ê¸°:  â€¦ë™ + (ë²ˆí˜¸)
    // ì˜ˆ) "ì„œìš¸ì‹œ â€¦ ë©´ëª©ë™ 458-34 B101í˜¸" â†’ "ì„œìš¸ì‹œ â€¦ ë©´ëª©ë™ 458-34"
    function _baseJibun(s){
      const tks = _splitTokens(s);
      if(!tks.length) return "";
      let last = tks.length - 1;

      // ë’¤ìª½ ê¼¬ë¦¬(í˜¸/ì¸µ ë“±) ì˜ë¼ë‚´ê¸°
      while(last >= 0 && (_TAIL_RE.test(tks[last]) || /í˜¸$/.test(tks[last]) || /ì¸µ$/.test(tks[last]))){
        last--;
      }
      // ...ë™ ë²ˆí˜¸(ë˜ëŠ” ë²ˆí˜¸-ë²ˆí˜¸)ê¹Œì§€ í¬í•¨
      let dongIdx = -1, noIdx = -1;
      for(let i=0;i<=last;i++){
        if(_DONG_RE.test(tks[i])) dongIdx = i;
      }
      for(let j=dongIdx+1;j<=last;j++){
        if(_HOUSE_NO_RE.test(tks[j])){ noIdx = j; break; }
      }
      if(noIdx >= 0) return _normalizeAddr(tks.slice(0, noIdx+1).join(" "));
      return _normalizeAddr(tks.slice(0, last+1).join(" "));
    }

    // ì£¼ì†Œì—ì„œ "ê¸°ë³¸ ë„ë¡œëª…" êµ¬ê°„ë§Œ ë‚¨ê¸°ê¸°:  â€¦ë¡œ/â€¦ê¸¸(+ë¡œìˆ«ìê¸¸) + (ë²ˆí˜¸)
    // ì˜ˆ) "ê²¸ì¬ë¡œ30ê¸¸ 42 (â—‹â—‹ë¹Œë¼) 101í˜¸" â†’ "ê²¸ì¬ë¡œ30ê¸¸ 42"
    function _baseRoad(s){
      const tks = _splitTokens(s);
      if(!tks.length) return "";
      let last = tks.length - 1;
      while(last >= 0 && (_TAIL_RE.test(tks[last]) || /í˜¸$/.test(tks[last]) || /ì¸µ$/.test(tks[last]))){
        last--;
      }
      let roadIdx = -1, noIdx = -1;
      for(let i=0;i<=last;i++){
        if(_ROAD_MIX_RE.test(tks[i]) || _ROAD_END_RE.test(tks[i])) { roadIdx = i; break; }
      }
      if(roadIdx >= 0){
        for(let j=roadIdx+1;j<=last;j++){
          if(_HOUSE_NO_RE.test(tks[j])){ noIdx = j; break; }
        }
        if(noIdx >= 0) return _normalizeAddr(tks.slice(0, noIdx+1).join(" "));
      }
      return _normalizeAddr(tks.slice(0, last+1).join(" "));
    }

    // ë¹„êµìš© í‚¤ ì„¸íŠ¸ ë§Œë“¤ê¸°
    function _addrKeys(s){
      const n = _normalizeAddr(s);
      return new Set([
        n,
        _baseJibun(n),
        _baseRoad(n),
      ].filter(Boolean));
    }

    // ìš°ë¦¬ ëª©ë¡(data)ì—ì„œ 'ê²€ìƒ‰ì–´ì™€ ê°™ì€ ê¸°ë³¸ì£¼ì†Œ' ë§¤ë¬¼ ì°¾ê¸°
    // - ê²€ìƒ‰ ê²°ê³¼ì˜ road/jibun ê¸°ë³¸í˜•ê³¼ row.address/roadAddress/jibunAddress ê¸°ë³¸í˜•ì„ ë¹„êµ
    // - ì™„ì „ì¼ì¹˜ ë˜ëŠ” 'ë’¤ìª½ì´ ë™ì¼'(ì˜ˆ: "ë©´ëª©ë™ 458-34" âŠ‚ "ì„œìš¸ì‹œ ì¤‘ë‘êµ¬ ë©´ëª©ë™ 458-34")
    function findListingsByAddressFlexible(road, jibun){
      const roadKeys  = _addrKeys(road||"");
      const jibunKeys = _addrKeys(jibun||"");

      function isMatch(row){
        const cands = [
          row.address, row.roadAddress, row.jibunAddress
        ].filter(Boolean);

        for(const c of cands){
          const rkeys = _addrKeys(c);
          // êµì§‘í•©(ì™„ì „ì¼ì¹˜) ìš°ì„ 
          for(const k of rkeys){ if(roadKeys.has(k) || jibunKeys.has(k)) return true; }
          // ë’¤ìª½ ë™ì¼(ê²€ìƒ‰ì–´ê°€ ë” ì§§ì€ tailì´ì–´ë„ OK)
          const longList = Array.from(rkeys);
          const shortList= Array.from(new Set([...roadKeys, ...jibunKeys]));
          for(const L of longList){
            for(const S of shortList){
              if(!S || !L) continue;
              // ë¬¸ì¥ ê²½ê³„ ì•ˆì „í•˜ê²Œ: ê³µë°±/ì½¤ë§ˆ ê¸°ì¤€ìœ¼ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸
              if(L.endsWith(S) && (L===S || /\b|,/.test(L[L.length - S.length - 1]||" "))){
                return true;
              }
            }
          }
        }
        return false;
      }

      return data.filter(isMatch);
    }

    /* ========== í•„í„°(ì§€ë„ bounds í¬í•¨) ========== */
    function currentFilters(){
      return {
        // types: []ë©´ 'ì „ì²´'ë¡œ ê°„ì£¼(= íƒ€ì… í•„í„° ë¯¸ì ìš©)
        types: getSelectedTypes(),
        minP: normalizeNumber($("minPrice")?.value),
        maxP: normalizeNumber($("maxPrice")?.value),
        minR: normalizeNumber($("minRent")?.value),
        maxR: normalizeNumber($("maxRent")?.value),
        loanSel: $("loanFilter")?.value || "",
        roomSel: $("roomFilter")?.value || "",
        parkingSel: $("parkingFilter")?.value || "",
        petsSel: $("petsFilter")?.value || ""
      };
    }
    function passesRoomFilter(roomValue,want){
      const n=normalizeNumber(roomValue);
      if(want===""||want==null) return true;
      if(n==null) return false;
      if(want==="1")return n===1;
      if(want==="2")return n===2;
      if(want==="3+")return n>=3;
      return true;
    }
    function stateMatches(val,want){
      if(!want) return true;
      const st=ynState(val);
      if(want==="yes")return st==="yes";
      if(want==="no")return st==="no";
      return true;
    }
    function isInBounds(row){
      if(!map||!row._marker) return true;
      const b = map.getBounds();
      return b.contain(row._marker.getPosition());
    }
    function rowPassesFilters(row,f){
      // â–¼ íƒ€ì…: f.typesê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ OR ë§¤ì¹­
      if (f.types && f.types.length > 0){
        if (!f.types.includes(normType(row.type))) return false;
      }
      const p=normalizeNumber(row.depositOrPrice), r=normalizeNumber(row.rent);
      if(f.minP!=null && (p==null||p<f.minP)) return false;
      if(f.maxP!=null && (p==null||p>f.maxP)) return false;
      if(f.minR!=null && (r==null||r<f.minR)) return false;
      if(f.maxR!=null && (r==null||r>f.maxR)) return false;
      if(f.loanSel){ const code=loanState(row.loan).code; if(f.loanSel!==code) return false; }
      if(!stateMatches(row.parking,f.parkingSel)) return false;
      if(!stateMatches(row.pets,f.petsSel)) return false;
      if(!passesRoomFilter(row.rooms,f.roomSel)) return false;
      if(!isInBounds(row)) return false;
      return true;
    }
    function debounce(fn,ms){ let t; return function(){ const a=arguments; clearTimeout(t); t=setTimeout(()=> fn.apply(null,a), ms); }; }
    const applyDebounced=debounce(applyFilter,200);
    function bindAutoFilters(){
      ["loanFilter","roomFilter","parkingFilter","petsFilter"].forEach(id=> on($(id),"change",applyFilter));
      ["minPrice","maxPrice","minRent","maxRent"].forEach(id=> on($(id),"input",applyDebounced));
    }

    function getSelectedTypes(){
      const allOn     = $("chipAll")?.getAttribute("aria-pressed") === "true";
      const saleOn    = $("chipSale")?.getAttribute("aria-pressed") === "true";
      const jeonseOn  = $("chipJeonse")?.getAttribute("aria-pressed") === "true";
      const monthlyOn = $("chipMonthly")?.getAttribute("aria-pressed") === "true";

      // ì „ì²´ ONì´ë©´ íƒ€ì… í•„í„° ë¯¸ì ìš©(= ëª¨ë‘ ë³´ì´ê¸°)
      if (allOn) return [];

      // ì „ì²´ OFF ì´ê³  ë‚˜ë¨¸ì§€ë„ ì „ë¶€ OFFë©´ â†’ ì „ë¶€ ìˆ¨ê¹€ ì‹ í˜¸
      if (!saleOn && !jeonseOn && !monthlyOn) return "__HIDE_ALL__";

      const sel = [];
      if (saleOn)    sel.push("ë§¤ë§¤");
      if (jeonseOn)  sel.push("ì „ì„¸");
      if (monthlyOn) sel.push("ì›”ì„¸");
      return sel;
    }

    function bindTypeChips(){
      const chips = {
        all: $("chipAll"),
        sale: $("chipSale"),
        jeonse: $("chipJeonse"),
        monthly: $("chipMonthly")
      };
      const setPressed = (el,on)=> el && el.setAttribute("aria-pressed", on ? "true" : "false");

      // ì „ì²´: í† ê¸€ + ë‚˜ë¨¸ì§€ëŠ” í•­ìƒ OFF
      chips.all && chips.all.addEventListener("click", (e)=>{
        e.stopPropagation();
        const was = chips.all.getAttribute("aria-pressed") === "true";
        setPressed(chips.all, !was); // â† ë‹¤ì‹œ ëˆ„ë¥´ë©´ false
        setPressed(chips.sale, false);
        setPressed(chips.jeonse, false);
        setPressed(chips.monthly, false);
        applyFilter();               // ì „ì²´ OFFë©´ "__HIDE_ALL__"ë¡œ ì²˜ë¦¬
      });

      // ê°œë³„ ì¹©: í† ê¸€. 'ì „ì²´'ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ë„ê³  ì§„í–‰
      ["sale","jeonse","monthly"].forEach(k=>{
        const el = chips[k];
        if(!el) return;
        el.addEventListener("click", (e)=>{
          e.stopPropagation();
          if (chips.all?.getAttribute("aria-pressed")==="true") setPressed(chips.all,false);
          const was = el.getAttribute("aria-pressed")==="true";
          setPressed(el, !was);
          // ì´ì œ ì•„ë¬´ ê²ƒë„ ì„ íƒ ì•ˆ í•˜ë©´ ì „ë¶€ ìˆ¨ê¹€ ìƒíƒœê°€ ë¨(ìë™ ì „ì²´ ë³µê·€ ì œê±°)
          applyFilter();
        });
      });
    }

    function applyFilter(){
      const f = currentFilters();
      // â–² currentFilters() ë‚´ë¶€ì—ì„œ getSelectedTypes()ë¥¼ í˜¸ì¶œí•œë‹¤ë©´,
      //   f.types === "__HIDE_ALL__" ì¸ ê²½ìš°ë¥¼ ë¨¼ì € ì²˜ë¦¬
      if (f.types === "__HIDE_ALL__") {
        renderList([]);
        data.forEach(row => { if (row._marker) row._marker.__visible = false; });
        updateClusteringForLevel();
        return;
      }

      const filtered = data.filter(row => rowPassesFilters(row, f));
      renderList(filtered);
      const filteredSet = new Set(filtered);
      data.forEach(row => {
        const inSet = filteredSet.has(row);
        if (row._marker) row._marker.__visible = inSet;
        if (!inSet && activeRow === row) { collapseAll(); }
      });
      updateClusteringForLevel();
      scheduleWarmPrefetch();
    }

    /* === [WARM] í˜„ì¬ í™”ë©´ì—ì„œ í”„ë¦¬íŒ¨ì¹˜ ëŒ€ìƒ í´ë”ID ìˆ˜ì§‘ === */
    function collectVisibleFolderIdsForWarm() {
      try{
        const ids = [];
        const seen = new Set();

        // í™”ë©´ ë‚´ + í•„í„° í†µê³¼í•œ ë§ˆì»¤ë§Œ
        data.forEach(row => {
          if (!row || !row._marker) return;
          if (!row._marker.__visible) return;       // í•„í„°ì—ì„œ ì œì™¸ëœ ë§ˆì»¤ëŠ” íŒ¨ìŠ¤
          if (!isInBounds(row)) return;             // ì§€ë„ bounds ë°–ì´ë©´ íŒ¨ìŠ¤
          const fid = row.photosFolderId || "";
          if (!fid) return;
          if (seen.has(fid)) return;
          seen.add(fid);
          ids.push(fid);
        });

        // ìš°ì„ ìˆœìœ„: í˜„ì¬ í™•ëŒ€ ì •ë„ì— ë”°ë¼ ê°€ê¹Œìš´ ìˆœì´ ìœ ë¦¬í•˜ì§€ë§Œ,
        // ê°„ë‹¨íˆ ìµœëŒ€ Nê°œë§Œ ìë¥´ê¸°
        return ids.slice(0, WARM.maxIds);
      }catch(e){
        return [];
      }
    }

    /* === [WARM] ì„œë²„-side warmImageCaches() ë””ë°”ìš´ìŠ¤ í˜¸ì¶œ === */
    function scheduleWarmPrefetch() {
      clearTimeout(WARM.timer);
      WARM.timer = setTimeout(() => {
        const ids = collectVisibleFolderIdsForWarm();
        if (!ids.length) return;

        const key = ids.join("|");
        if (key === WARM.lastKey) return; // ê°™ì€ ëŒ€ìƒì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        WARM.lastKey = key;

        google.script.run
          .withSuccessHandler(() => { /* no-op: ìºì‹œë§Œ ì±„ì›€ */ })
          .withFailureHandler(() => { /* ì¡°ìš©íˆ ë¬´ì‹œ */ })
          .warmImageCaches(ids);
      }, WARM.debounceMs);
    }

    /* ========== pill(ë§í’ì„ ) ========== */
    function pillHTML(row){
      const kind = typeToken(row.type);
      const top  = String(row.houseType || "-");
      const priceTxt = compactPriceLine(row);
      return ''+
        '<div class="marker-bubble-wrap">'+
        '  <div class="marker-bubble">'+
        '    <div class="sec sec-top '+kind+'">'+ top +'</div>'+
        '    <div class="sec sec-bottom">'+ priceTxt +'</div>'+
        '  </div>'+
        '  <i class="marker-tail"></i>'+
        '</div>';
    }
    function clearPills(){ markerPills.forEach(o=>o.setMap && o.setMap(null)); markerPills=[]; }
    function pillShouldShow(row){
      const m = row._marker, ov = row._pill;
      if(!m || !ov) return false;
      if(ov.__hidden) return false;           // ì¹´ë“œ í™•ì¥ ë“±ìœ¼ë¡œ ìˆ¨ê¸´ ìƒíƒœë©´ í‘œì‹œ ì•ˆ í•¨
      return !!m.__visible && !!m.getMap();   // ë§ˆì»¤ê°€ í•„í„° í†µê³¼í–ˆê³  ì‹¤ì œ ì§€ë„ì— ì˜¬ë¼ì˜¨ ê²½ìš°
    }
    function syncPill(row){
      const ov = row._pill, m = row._marker;
      if(!ov || !m) return;
      if(pillShouldShow(row)){
        ov.setPosition(m.getPosition());
        ov.setMap(map);
      } else {
        ov.setMap(null);
      }
    }
    function refreshPills(){
      data.forEach(syncPill);
    }

    /* ========== ìƒì„¸ ì¹´ë“œ ========== */
    function buildExpandedEl(row){
      const wrap = document.createElement('div'); 
      wrap.className = 'wrap';

      const tClass = typeCssClass(row.type);
      const depo   = formatKRWMan(normalizeNumber(row.depositOrPrice));
      const isMonthly = (normType(row.type)==="ì›”ì„¸");
      const monthly = isMonthly ? (' / <b>ì›”ì„¸ '+formatKRWMan(normalizeNumber(row.rent))+'</b>') : '';

      // ìˆœì„œ: ì£¼ì†Œ(íƒ€ì´í‹€) â†’ ê°¤ëŸ¬ë¦¬(ìˆìœ¼ë©´) â†’ ì •ë³´ ë³¸ë¬¸
      wrap.innerHTML =
        '<div class="info">'+
        // 1) ì£¼ì†Œ(íƒ€ì´í‹€)
        '  <div class="title '+tClass+'" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">'+
        '    <span style="flex:1 1 auto;min-width:0;">'+(compactAptLabel(row))+'</span>'+
        '    <button class="panel-close" title="ë‹«ê¸°" aria-label="ë‹«ê¸°">Ã—</button>'+
        '  </div>'+
        // 2) ê°¤ëŸ¬ë¦¬(ì˜µì…˜)
        (row.photosFolderId 
          ? '<div class="gallery" data-fid="'+row.photosFolderId+'">'+
            '    <div class="gallery-inner"><div class="gallery-empty">ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>'+
            '    <button class="gallery-prev" aria-label="ì´ì „">â€¹</button>'+
            '    <button class="gallery-next" aria-label="ë‹¤ìŒ">â€º</button>'+
            '  </div>'
          : ''
        )+
        // 3) ì •ë³´ ë³¸ë¬¸
        '  <div class="body">'+
        '    <div class="xsmall" style="margin-bottom:6px;">'+
        '      <span class="badge '+typeToken(row.type)+'">'+normType(row.type)+'</span> '+
        '      <b>'+depo+'</b>'+ monthly +
        '    </div>'+
        '    <div class="small muted">'+(row.sheet||"")+'</div>'+
        '    <div class="rowchips" style="margin-top:6px;">'+
        '      <span class="chip">'+(row.houseType||"ìœ í˜•?")+'</span>'+
        '      <span class="chip">'+(row.area?(row.area+"ã¡"):"ë©´ì ?")+'</span>'+
        '    </div>'+
        '    <div class="rowchips" style="margin-top:6px;">'+
        '      <span class="chip">'+((row.floor||row.floor===0)?(row.floor+"ì¸µ"):"ì¸µìˆ˜?")+'</span>'+
        '      <span class="chip">'+((row.rooms!=null&&row.rooms!=="")?("ë°© "+row.rooms):"ë°©?")+'</span>'+
        '      <span class="chip">'+((row.baths!=null&&row.baths!=="")?("ìš•ì‹¤ "+row.baths):"ìš•ì‹¤?")+'</span>'+
        '    </div>'+
        '    <div class="rowchips xsmall" style="margin-top:6px;">'+
        '      <span>ëŒ€ì¶œ '+loanChip(row.loan)+'</span>'+
        '      <span>ì£¼ì°¨ '+ynChip(row.parking)+'</span>'+
        '      <span>ë°˜ë ¤ '+ynChip(row.pets)+'</span>'+
        '    </div>'+
        '  </div>'+
        '</div>';

      return wrap;
    }
    function initGalleryForCard(cardEl, folderId){
      const gal = cardEl.querySelector('.gallery'); 
      if(!gal || !folderId) return;

      const inner = gal.querySelector('.gallery-inner');
      const btnPrev = gal.querySelector('.gallery-prev');
      const btnNext = gal.querySelector('.gallery-next');

      google.script.run
        .withSuccessHandler(function(list){
          if(!list || !list.length){
            inner.innerHTML = '<div class="gallery-empty">ì‚¬ì§„ ì—†ìŒ</div>';
            btnPrev.style.display = btnNext.style.display = 'none';
            return;
          }
          let idx = 0;

          function bestWidthFor(container, originalW){
            const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));   // ê³¼ë„í•œ 3x ì´ìƒ ë°©ì§€
            const cssW = container.clientWidth || 320; // ì¹´ë“œ í­(ëŒ€ëµ 320px)
            const target = Math.round(cssW * dpr * 1.2);  // ì•½ê°„ ì—¬ìœ 
            const capped = Math.min(target, originalW || target, 1800); // ì›ë³¸ì´ˆê³¼/ê³¼ëŒ€ìš”ì²­ ë°©ì§€
            return Math.max(600, capped); // ë„ˆë¬´ ì‘ì€ ì¸ë„¤ì¼ ë°©ì§€
          }

          function render(){
            inner.innerHTML = '';
            const meta = list[idx] || {};
            const baseThumb = meta.thumb || '';
            // Drive ì¸ë„¤ì¼ ì‚¬ì´ì¦ˆ íŒŒë¼ë¯¸í„° ë¶™ì´ê¸° (&sz=wNNN)
            const reqW = bestWidthFor(gal, meta.width);
            const src  = baseThumb ? (baseThumb + '&sz=w' + reqW) : (meta.url || '');
            const img = document.createElement('img');
            // í™”ì§ˆ ìš°ì„ : url(ì›ë³¸ ë¯¸ë¦¬ë³´ê¸°) â†’ thumb(í° ì¸ë„¤ì¼)
            img.src = src;
            img.alt = (list[idx].name || '');
            img.loading = 'lazy';
            img.decoding = 'async';
            inner.appendChild(img);
          }
          btnPrev.onclick = function(e){ e.stopPropagation(); idx = (idx - 1 + list.length) % list.length; render(); };
          btnNext.onclick = function(e){ e.stopPropagation(); idx = (idx + 1) % list.length; render(); };
          render();
        })
        .withFailureHandler(function(err){
          console.error('[gallery] load failed:', err);
          inner.innerHTML = '<div class="gallery-empty">ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
          btnPrev.style.display = btnNext.style.display = 'none';
        })
        .listImagesInFolder(folderId);
    }
    function closeOnlyCards(){
      if (activeCard){ try{ activeCard.setMap(null); }catch(_){ } activeCard = null; }
      if (activeRow && activeRow._pill){
        activeRow._pill.__expanded = false; activeRow._pill.__hidden = false; activeRow._pill.setZIndex(9000);
        syncPill(activeRow); 
      }
      activeRow = null;
      refreshPills();
    }
    function collapseAll(){
      clearSpider();
      if(activeCard){ try{ activeCard.setMap(null);}catch(_){ } activeCard=null; }
      if(activeRow && activeRow._pill){
        activeRow._pill.__expanded = false; activeRow._pill.__hidden = false; activeRow._pill.setZIndex(9000);
        syncPill(activeRow); 
      }
      activeRow = null;
      refreshPills();
    }
    function openCardFor(row, pos, recenter){
      if(!row) return;
      closeOnlyCards();
      const position = pos || (row._marker ? row._marker.getPosition() : null);
      if(!position) return;
      if(row._pill){ row._pill.__expanded = true; row._pill.__hidden = true; row._pill.setMap(null); }
      const el = buildExpandedEl(row);
      const closeBtn = el.querySelector('.panel-close');
      if (closeBtn){
        closeBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          closeOnlyCards(); // ìƒì„¸ ì¹´ë“œë§Œ ë‹«ê¸°
        });
      }
      const ov = new kakao.maps.CustomOverlay({ position: position, content: el, yAnchor:1.05, xAnchor:0.5, zIndex:100000, clickable:true });
      ov.setMap(map);
      bindHoverZForOverlay(ov, el, 100500, 100000);
      activeRow = row; activeCard = ov;
      requestAnimationFrame(()=> el.classList.add('show'));
      if (recenter){ smoothPanTo(position); }

      if (row.photosFolderId) {
        const info = el.querySelector('.info');
        initGalleryForCard(info, row.photosFolderId);
      }
    }

    /* ========== í´ëŸ¬ìŠ¤í„° í”„ë¦¬ì…‹: KEY(PURPLE) ========== */
    const CLUSTER_PRESETS = {
      key: {
        // ë‹¨ê³„ ê²½ê³„(ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        calculator: [3, 6, 9, 12, 15],
        // ì‘ì€ â†’ í°
        styles: [
          { width:'28px', height:'28px', background:'#ACA3C4E6', color:'#FFFFFF', hoverText:'#AEA5C6', borderRadius:'999px', border:'1px solid #ACA3C4E6', textAlign:'center', lineHeight:'28px', fontSize:'12px', fontWeight:'900', boxShadow:'0 2px 6px rgba(0,0,0,0.18)', textShadow:'0 1px 2px rgba(0,0,0,0.40)', cursor:'pointer' },
          { width:'34px', height:'34px', background:'#9F94BBE6', color:'#FFFFFF', hoverText:'#9286B2', borderRadius:'999px', border:'1px solid #9F94BBE6', textAlign:'center', lineHeight:'34px', fontSize:'12px', fontWeight:'900', boxShadow:'0 3px 10px rgba(0,0,0,0.20)', textShadow:'0 1px 2px rgba(0,0,0,0.42)', cursor:'pointer' },
          { width:'42px', height:'42px', background:'#9185B1E6', color:'#FFFFFF', hoverText:'#76679E', borderRadius:'999px', border:'1px solid #9185B1E6', textAlign:'center', lineHeight:'42px', fontSize:'13px', fontWeight:'900', boxShadow:'0 4px 12px rgba(0,0,0,0.22)', textShadow:'0 1px 2px rgba(0,0,0,0.44)', cursor:'pointer' },
          { width:'52px', height:'52px', background:'#8376A7E6', color:'#FFFFFF', hoverText:'#5E5280', borderRadius:'999px', border:'1px solid #8376A7E6', textAlign:'center', lineHeight:'52px', fontSize:'14px', fontWeight:'900', boxShadow:'0 6px 16px rgba(0,0,0,0.24)', textShadow:'0 1px 2px rgba(0,0,0,0.46)', cursor:'pointer' },
          { width:'64px', height:'64px', background:'#76679EE6', color:'#FFFFFF', hoverText:'#483E61', borderRadius:'999px', border:'1px solid #76679EE6', textAlign:'center', lineHeight:'64px', fontSize:'16px', fontWeight:'900', boxShadow:'0 8px 20px rgba(0,0,0,0.26)', textShadow:'0 1px 2px rgba(0,0,0,0.48)', cursor:'pointer' }
        ]
      }
    };

    function clusterStyleForCount(preset, count){
      const calc = preset.calculator || []; let idx = 0;
      for (let i=0;i<calc.length;i++){ if (count > calc[i]) idx = i+1; else break; }
      const styles = preset.styles || []; if (idx >= styles.length) idx = styles.length - 1; if (idx < 0) idx = 0; return styles[idx];
    }
    function getClusterElement(cluster){
      try{
        const cm = cluster.getClusterMarker ? cluster.getClusterMarker() : null;
        if (cm && cm.getContent){
          let el = cm.getContent();
          if (typeof el === 'string'){
            const span = document.createElement('span'); span.innerHTML = el; cm.setContent(span); return span;
          }
          return el;
        }
      }catch(e){}
      return null;
    }
    function setClusterHoverVisual(cluster, preset, hovering){
      const el = getClusterElement(cluster); if (!el) return;
      const count = (cluster.getSize ? cluster.getSize() : (cluster.getMarkers ? cluster.getMarkers().length : 0)) || 0;
      const base  = clusterStyleForCount(preset, count);
      if (!hovering){
        el.style.background = base.background; el.style.border = base.border || ''; el.style.color = base.color || '#fff'; el.style.boxShadow = base.boxShadow || ''; el.style.textShadow = base.textShadow || '';
        return;
      }
      el.style.background = 'rgba(255,255,255,0.88)'; el.style.border = base.border || '1px solid rgba(0,0,0,0.08)'; el.style.color = base.hoverText || '#CA8A04'; el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.20)'; el.style.textShadow='none';
    }
    function attachClusterHoverHandlers(clusterer, preset){
      kakao.maps.event.addListener(clusterer, 'clusterover', (cluster)=>{
        setClusterHoverVisual(cluster, preset, true);
        try{
          const cm = cluster.getClusterMarker && cluster.getClusterMarker();
          if (cm){
            if (cm.__baseZ == null) cm.__baseZ = (cm.getZIndex && cm.getZIndex()) || 0;
            cm.setZIndex(15000); // hover ìƒìŠ¹
          }
        }catch(_){}
      });
      kakao.maps.event.addListener(clusterer, 'clusterout',  (cluster)=>{
        setClusterHoverVisual(cluster, preset, false);
        try{
          const cm = cluster.getClusterMarker && cluster.getClusterMarker();
          if (cm) cm.setZIndex(cm.__baseZ || 0); // ì›ë³µ
        }catch(_){}
      });
    }

    /* ========== ì (ë‹·) ë§ˆì»¤ ì´ë¯¸ì§€ ========== */
    const DOT_SIZE = 20;

    function _svgOutlined(size, fill){
      const r = Math.floor(size/2);
      return '<svg xmlns="http://www.w3.org/2000/svg" width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">'+
            '<circle cx="'+r+'" cy="'+r+'" r="'+(r-1)+'" fill="#ffffff"/>'+
            '<circle cx="'+r+'" cy="'+r+'" r="'+(r-4)+'" fill="'+fill+'"/></svg>';
    }

    // âœ… ë§ˆì»¤ ì´ë¯¸ì§€ ìºì‹œ
    const _MARKER_IMG_CACHE = {};
    function markerImageFor(colorKey){               // colorKey = 'red' | 'blue' | 'green'
      if (_MARKER_IMG_CACHE[colorKey]) return _MARKER_IMG_CACHE[colorKey];

      const fill = colorVar(colorKey);               // â† ì‹¤ì œ HEXë¡œ ì¹˜í™˜
      const size = DOT_SIZE;
      const r    = Math.floor(size/2);
      const svg  = _svgOutlined(size, fill);
      const url  = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);

      const img  = new kakao.maps.MarkerImage(
        url,
        new kakao.maps.Size(size, size),
        { offset: new kakao.maps.Point(r, r) }
      );
      _MARKER_IMG_CACHE[colorKey] = img;
      return img;
    }

    /* ========== í´ëŸ¬ìŠ¤í„°/ë§ˆì»¤ êµ¬ì„± ========== */
    function clusterSignature(cluster){
      try{
        const ms = cluster.getMarkers() || [];
        const keys = ms.map(m=>{ const p=m.getPosition(); return p.getLat().toFixed(6)+','+p.getLng().toFixed(6); }).sort();
        if(keys.length===0){ const c = cluster.getCenter(); keys.push('C:'+c.getLat().toFixed(6)+','+c.getLng().toFixed(6)); }
        return keys.join('|');
      }catch(e){ return 'err-'+Date.now(); }
    }
    function isSameAddressCluster(cluster){
      try{
        const ms = cluster.getMarkers() || []; if (ms.length === 0) return false;
        const key = ms[0].__groupKey;
        for (let i=0;i<ms.length;i++){ if (!ms[i].__isSameGroup || ms[i].__groupKey !== key) return false; }
        return true;
      }catch(e){ return false; }
    }
    function updateClusteringForLevel(){
      if(!clusterer || !map) return;
      clusterer.clear();
      const toAdd = [];
      const level = map.getLevel();

      data.forEach(function(row){
        const m = row._marker; if(!m) return;
        if(!m.__visible){ m.setMap(null); return; }

        if(level <= UNCLUSTER_NEAR_LEVEL && !m.__isSameGroup){
          m.setMap(map);
        } else {
          m.setMap(null);
          toAdd.push(m);
        }
      });
      if(toAdd.length) clusterer.addMarkers(toAdd);

      // pillì€ ë§ˆì»¤ ìƒíƒœì™€ ë™ê¸°í™”
      refreshPills();
    }

    /* ========== ìŠ¤íŒŒì´ë” ========== */
    function clearSpider(){
      spiderMarkers.forEach(m=>{ try{ m.setMap(null);}catch(_){ } });
      spiderLegs.forEach(l=>{ try{ l.setMap(null);}catch(_){ } });
      spiderCards.forEach(o=>{ try{ o.setMap(null);}catch(_){ } });
      spiderPills.forEach(o=>{ try{ o.setMap(null);}catch(_){ } });
      spiderMarkers = []; spiderLegs = []; spiderCards = []; spiderPills = [];
      refreshPills();
      spiderAnimating.clear(); spiderOpened.clear();
    }
    function tweenPositions(fromPos, toPos, duration, onUpdate, onDone){
      const start = performance.now(); const proj = map.getProjection();
      const fp = proj.containerPointFromCoords(fromPos); const tp = proj.containerPointFromCoords(toPos);
      function step(now){
        const t = Math.min(1, (now - start)/duration);
        const e = 1 - Math.pow(1 - t, 3);
        const x = fp.x + (tp.x - fp.x)*e; const y = fp.y + (tp.y - fp.y)*e;
        const pos = proj.coordsFromContainerPoint(new kakao.maps.Point(x,y));
        onUpdate(pos); if(t<1){ requestAnimationFrame(step); } else { onDone && onDone(); }
      }
      requestAnimationFrame(step);
    }
    function computeSpiderRadius(count){
      const spacing = 60, minR=60, maxR=180; let R=(count*spacing)/(2*Math.PI); if (count<=3) R+=10;
      if(R<minR) R=minR; if(R>maxR) R=maxR; return Math.round(R);
    }
    function spiderCluster(cluster, sig){
      const markers = cluster.getMarkers(); if(!markers || markers.length<=1){ if(sig) spiderAnimating.delete(sig); return; }
      const center = cluster.getCenter(); const proj = map.getProjection(); const cPt = proj.containerPointFromCoords(center);
      let pending = markers.length; const R = computeSpiderRadius(markers.length);
      const endPositions = [];
      if (markers.length >= 9){
        const innerCount = Math.min(6, markers.length); const outerCount = markers.length - innerCount;
        const innerR = Math.max(60, Math.round(R * 0.62)); const outerR = Math.round(R * 1.10);
        const innerStep = (2*Math.PI)/innerCount; const outerStep = outerCount>0 ? (2*Math.PI)/outerCount : 0;
        const innerOffset=0, outerOffset=innerStep/2;
        for(let i=0;i<innerCount;i++){ const a=innerOffset+innerStep*i; const p=new kakao.maps.Point(cPt.x+innerR*Math.cos(a), cPt.y+innerR*Math.sin(a)); endPositions.push(proj.coordsFromContainerPoint(p)); }
        for(let j=0;j<outerCount;j++){ const b=outerOffset+outerStep*j; const q=new kakao.maps.Point(cPt.x+outerR*Math.cos(b), cPt.y+outerR*Math.sin(b)); endPositions.push(proj.coordsFromContainerPoint(q)); }
      }else{
        const step=(2*Math.PI)/markers.length;
        for(let k=0;k<markers.length;k++){ const ang=step*k; const rpt=new kakao.maps.Point(cPt.x+R*Math.cos(ang), cPt.y+R*Math.sin(ang)); endPositions.push(proj.coordsFromContainerPoint(rpt)); }
      }
      for (let m=0; m<markers.length; m++){
        (function(mk, endPos){
          const leg = new kakao.maps.Polyline({ map, path:[center,center], strokeWeight:1.5, strokeColor:'#9ca3af', strokeOpacity:0.7, strokeStyle:'solid', zIndex:9200 });
          spiderLegs.push(leg);
          const row = mk.__row; const img = markerImageFor(typeToken(row.type));
          const sm = new kakao.maps.Marker({ position:center, image:img, zIndex:9300 }); sm.setMap(map); spiderMarkers.push(sm);
          let pillDiv = document.createElement('div'); pillDiv.innerHTML = pillHTML(row); pillDiv = pillDiv.firstChild;
          pillDiv.addEventListener('click', (e)=>{ e.stopPropagation(); openCardFor(row, endPos, false); nudgeIfEdge(endPos); });
          const spOv = new kakao.maps.CustomOverlay({ position:center, content:pillDiv, xAnchor:0.5, yAnchor:1.15, zIndex:9350, clickable:true });
          spOv.setMap(map); spiderPills.push(spOv);
          bindHoverZForMarker(sm, 14000);
          bindHoverZForOverlay(spOv, pillDiv, 14100, 9350);
          tweenPositions(center, endPos, 180, function(pos){ sm.setPosition(pos); leg.setPath([center,pos]); spOv.setPosition(pos); }, function(){
            kakao.maps.event.addListener(sm, 'click', function(){ openCardFor(row, endPos, false); nudgeIfEdge(endPos); });
            pending--; if (pending===0 && sig){ spiderAnimating.delete(sig); spiderOpened.add(sig); }
          });
        })(markers[m], endPositions[m]);
      }
    }

    /* ========== ì˜¤ë²„ë ˆì´(ëª¨ì•„/ì‹ ì†) ========== */
    function updateOverlayStat(moaCount,fastCount){ $("ovStat").textContent="ëª¨ì•„ "+moaCount+" / ì‹ ì† "+fastCount; }
    function clearPlanOverlays(){
      moaPolys.forEach(p=>p.setMap(null)); fastPolys.forEach(p=>p.setMap(null));
      planInfoWins.forEach(ov=>{ try{ ov.setMap(null);}catch(_){ } });
      moaPolys=[]; fastPolys=[]; planInfoWins=[];
      if (planHoverOverlay){ try{ planHoverOverlay.setMap(null);}catch(_){ } }
    }
    function ensurePlanHoverOverlay(){
      if (planHoverOverlay) return;
      planHoverOverlay = new kakao.maps.CustomOverlay({ xAnchor:0.5, yAnchor:1.2, zIndex:12000, clickable:false });
    }
    function showPlanHover(pos, kind, text){
      ensurePlanHoverOverlay();
      const el = document.createElement('div'); el.className = 'plan-label ' + (kind==='moa' ? 'moa' : 'fast'); el.textContent = text || '';
      planHoverOverlay.setContent(el); planHoverOverlay.setPosition(pos); planHoverOverlay.setMap(map);
    }
    function hidePlanHover(){ if (planHoverOverlay) planHoverOverlay.setMap(null); }
    function closePlanInfoWins(){
      planInfoWins.forEach(ov=>{ try{ ov.setMap(null);}catch(_){ } }); planInfoWins=[];
      if (planHoverOverlay){ planHoverOverlay.setMap(null); }
    }
    function makePlanCard(kind, name, stage){
      const wrap = document.createElement('div'); const isMoa = (kind === 'moa'); wrap.className = 'plan-card ' + (isMoa ? 'moa' : 'fast');
      const titleText = name || ''; const stageLine = stage ? ('<div class="stage">' + stage + '</div>') : '';
      wrap.innerHTML = '<div class="head">' + titleText + '</div>' + '<div class="body">' + stageLine + '</div>';
      return wrap;
    }
    function drawOverlays(over){
      clearPlanOverlays();
      if(!over || !map){ updateOverlayStat(0,0); return; }
      const styleM = { strokeWeight:2, strokeColor:"#10b981", strokeOpacity:1, fillColor:"#10b981", fillOpacity:0.12 };
      const styleF = { strokeWeight:2, strokeColor:"#ef4444", strokeOpacity:1, fillColor:"#ef4444", fillOpacity:0.12 };
      function bindPolygon(poly, meta, baseStyle, kind){
        kakao.maps.event.addListener(poly, 'mouseover', function(e){ poly.setOptions({ fillOpacity: 0.25 }); showPlanHover(e.latLng, kind, meta.rep); });
        kakao.maps.event.addListener(poly, 'mousemove', function(e){ showPlanHover(e.latLng, kind, meta.rep); });
        kakao.maps.event.addListener(poly, 'mouseout',  function(){ poly.setOptions({ fillOpacity: baseStyle.fillOpacity }); hidePlanHover(); });
        kakao.maps.event.addListener(poly, 'click', function(e){
          kakao.maps.event.preventMap(); hidePlanHover(); closePlanInfoWins();
          const card = new kakao.maps.CustomOverlay({ position:e.latLng, content:makePlanCard(kind, meta.name, meta.stage), xAnchor:0.5, yAnchor:1.02, zIndex:12010, clickable:true });
          card.setMap(map); planInfoWins.push(card);
          const contentEl = card.getContent && card.getContent();
          if (contentEl && typeof contentEl !== 'string'){
            bindHoverZForOverlay(card, contentEl, 12140, 12010);
          }
        });
      }
      let mc=0, fc=0;
      (over.moa||[]).forEach(function(p){
        if(!Array.isArray(p.vertices)||p.vertices.length<3) return;
        const path = p.vertices.map(v=> new kakao.maps.LatLng(v[0], v[1]));
        const poly = new kakao.maps.Polygon(Object.assign({ map, path }, styleM));
        const meta = { name: p.name || "", stage: p.stage || "", rep: p.repLot || p.name || "" };
        bindPolygon(poly, meta, styleM, 'moa'); moaPolys.push(poly); mc++;
      });
      (over.fast||[]).forEach(function(p){
        if(!Array.isArray(p.vertices)||p.vertices.length<3) return;
        const path = p.vertices.map(v=> new kakao.maps.LatLng(v[0], v[1]));
        const poly = new kakao.maps.Polygon(Object.assign({ map, path }, styleF));
        const meta = { name: p.name || "", stage: p.stage || "", rep: p.repLot || p.name || "" };
        bindPolygon(poly, meta, styleF, 'fast'); fastPolys.push(poly); fc++;
      });
      updateOverlayStat(mc,fc);
      kakao.maps.event.addListener(map, 'idle', function __onceOverlays() {
        kakao.maps.event.removeListener(map, 'idle', __onceOverlays);
        BOOT.overlays = true; bootCheck();
      });
    }
    function setLayerVisible(kind,on){
      const arr = (kind==="moa")?moaPolys:fastPolys;
      arr.forEach(p=> p.setMap(on?map:null));
    }

    function bindLayerPanel(){
      const fab   = $("layerFab");
      const panel = $("layerPanel");
      const btnM  = $("btnMoa");
      const btnF  = $("btnFast");

      // ìƒíƒœ ë™ê¸°í™”
      function sync(){
        btnM && btnM.setAttribute('aria-pressed', String(LAYER_STATE.moa));
        btnF && btnF.setAttribute('aria-pressed', String(LAYER_STATE.fast));
        setLayerVisible('moa',  LAYER_STATE.moa);
        setLayerVisible('fast', LAYER_STATE.fast);
      }

      // íŒ¨ë„ ì•ˆ í´ë¦­ì€ ë²„ë¸” ë§‰ê¸°(ì‹¤ìˆ˜ë¡œ ë‹«íˆì§€ ì•Šê²Œ)
      panel && panel.addEventListener('click', e => e.stopPropagation());

      // âœ… ì•„ì´ì½˜(FAB) í´ë¦­ìœ¼ë¡œë§Œ ì—´ê³ /ë‹«ê¸°
      fab && fab.addEventListener('click', (e)=>{
        e.stopPropagation();
        panel.classList.toggle('hidden');
      });

      // í† ê¸€ ë²„íŠ¼ ëˆŒëŸ¬ë„ íŒ¨ë„ì€ ë‹«íˆì§€ ì•ŠìŒ
      btnM && btnM.addEventListener('click', (e)=>{
        e.stopPropagation();
        LAYER_STATE.moa = !LAYER_STATE.moa;
        sync();
      });
      btnF && btnF.addEventListener('click', (e)=>{
        e.stopPropagation();
        LAYER_STATE.fast = !LAYER_STATE.fast;
        sync();
      });

      sync();
    }

    // â† êµì²´
    function bindLegendPanel(){
      const fab   = $("legendFab");
      const panel = $("legendPanel");

      // íŒ¨ë„ ì•ˆ í´ë¦­ì€ ë²„ë¸” ë§‰ê¸°
      panel && panel.addEventListener('click', e => e.stopPropagation());

      // âœ… ì•„ì´ì½˜(FAB) í´ë¦­ìœ¼ë¡œë§Œ ì—´ê³ /ë‹«ê¸°
      fab && fab.addEventListener('click', (e)=>{
        e.stopPropagation();
        panel.classList.toggle('hidden');
      });
    }

    /* ========== ë§ˆì»¤/í´ëŸ¬ìŠ¤í„° ì¬êµ¬ì„± ========== */
    function rebuildMarkers(rows){
      clearPills(); clearSpider();
      const PRESET = CLUSTER_PRESETS.key;
      data = rows || [];
      const bounds = new kakao.maps.LatLngBounds();
      const groups = Object.create(null);

      data.forEach(function(row){
        const lat = Number(row.lat), lng = Number(row.lng);
        if(!isFinite(lat) || !isFinite(lng)) return;

        const pos = new kakao.maps.LatLng(lat, lng);
        const img = markerImageFor(typeToken(row.type));
        const marker = new kakao.maps.Marker({ position: pos, image: img });
        marker.__row = row; marker.__visible = true;

        kakao.maps.event.addListener(marker, "click", function(){
          openCardFor(row, pos, false);
          nudgeIfEdge(pos);
        });

        let pillDiv = document.createElement('div');
        pillDiv.innerHTML = pillHTML(row);
        pillDiv = pillDiv.firstChild;
        pillDiv.addEventListener('click', function(e){
          e.stopPropagation();
          openCardFor(row, pos, false);
          nudgeIfEdge(pos);
        });

        const pill = new kakao.maps.CustomOverlay({
          position: pos, content: pillDiv, xAnchor:0.5, yAnchor:1.15, zIndex:9000, clickable:true
        });

        bindHoverZForMarker(marker, 14500);
        bindHoverZForOverlay(pill, pillDiv, 14600, 9000);

        row._marker = marker;
        row._pill = pill;
        markerPills.push(pill);
        bounds.extend(pos);

        const key = lat.toFixed(6) + "|" + lng.toFixed(6);
        marker.__groupKey = key;
        (groups[key] || (groups[key] = [])).push(marker);
      });

      // ê°™ì€ ì¢Œí‘œ ê·¸ë£¹ ì—¬ë¶€ í”Œë˜ê·¸ë§Œ ì„¤ì •(ë°°ì—´ì— ë”°ë¡œ ëª¨ìœ¼ì§€ ì•ŠìŒ)
      Object.keys(groups).forEach(k=>{
        const arr = groups[k];
        if (!arr || arr.length === 0) return;
        if (arr.length >= 2) arr.forEach(m=> m.__isSameGroup = true);
        else arr[0].__isSameGroup = false;
      });

      if(!clusterer){
        clusterer = new kakao.maps.MarkerClusterer({
          map, averageCenter:true, minLevel:0, gridSize:60, disableClickZoom:true,
          calculator: PRESET.calculator, styles: PRESET.styles
        });
        attachClusterHoverHandlers(clusterer, PRESET);

        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster){
          const sig = clusterSignature(cluster);
          if (spiderAnimating.has(sig) || spiderOpened.has(sig)) return;

          const level = map.getLevel();
          const same = isSameAddressCluster(cluster);
          const spiderLevel = same ? SAME_SPIDER_LEVEL : NEAR_SPIDER_LEVEL;

          if (level > spiderLevel){
            const center = cluster.getCenter();
            smoothPanZoomTo(center, map.getLevel() - 1);
            onceIdle(()=> setTimeout(()=> nudgeIfEdge(center), 120));
          } else {
            const center = cluster.getCenter();
            nudgeIfEdge(center);
            spiderAnimating.add(sig);
            setTimeout(()=> spiderCluster(cluster, sig), 180);
          }
        });
      }

      updateClusteringForLevel();

      if(!bounds.isEmpty()){
        map.setBounds(bounds);
      } else {
        map.setCenter(new kakao.maps.LatLng(37.5665,126.9780));
        map.setLevel(7);
      }

      applyFilter();
      kakao.maps.event.addListener(map, 'idle', function __onceListings() {
        kakao.maps.event.removeListener(map, 'idle', __onceListings);
        BOOT.listings = true; bootCheck();
      });

      scheduleWarmPrefetch();
    }

      /* ========== ì´ˆê¸°í™” & ë¡œë” ========== */
    function initApp(){
      map = new kakao.maps.Map($("map"), { center:new kakao.maps.LatLng(37.5665,126.9780), level:7 });
      geocoder = new kakao.maps.services.Geocoder();

      /* âœ… í–‰ì •êµ¬ì—­ ë°°ì§€ ê°±ì‹  ë°”ì¸ë”© */
      updateLocBadge();                                            // ì´ˆê¸° í•œ ë²ˆ
      kakao.maps.event.addListener(map, 'idle', updateLocBadge);   // íŒ¬/ì¤Œ ëë‚  ë•Œ
      kakao.maps.event.addListener(map, 'zoom_changed', updateLocBadge); // ì¤Œ ë‹¨ê³„ ë°”ë€” ë•Œ ì¦‰ì‹œ

      // ì¤Œì´ ë°”ë€Œë©´: ë§ˆì»¤â†”í´ëŸ¬ìŠ¤í„° ì¬ë°°ì¹˜ + ìŠ¤íŒŒì´ë” ì •ë¦¬ + pill ë™ê¸°í™”
      kakao.maps.event.addListener(map, 'zoom_changed', function () {
        updateClusteringForLevel();
        clearSpider();
        refreshPills();
        scheduleWarmPrefetch();
      });

      // ì§€ë„ ì´ë™/ì¤Œ ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ ë’¤: bounds í¬í•¨ í•„í„° ì¬ì ìš©
      kakao.maps.event.addListener(map, 'idle', function () {
        applyFilter();      // isInBounds()ê°€ í˜„ì¬ boundsë¡œ ë‹¤ì‹œ ê³„ì‚°ë¨
        scheduleWarmPrefetch();
      });

      /* ===== ì¤Œ ì»¨íŠ¸ë¡¤ ===== */
      const MIN_LEVEL = 1, MAX_LEVEL = 14;
      const TOTAL_STEPS = (MAX_LEVEL - MIN_LEVEL + 1);

      /* level(1..14) â†’ step(13..0) : ë ˆë²¨ 1ì´ ìµœìƒë‹¨(=step 13), 14ê°€ ìµœí•˜ë‹¨(=step 0) */
      function levelToStep(level){
        const lv = _clamp(Math.round(Number(level) || MAX_LEVEL), MIN_LEVEL, MAX_LEVEL);
        return (MAX_LEVEL - lv);
      }

      /* step(0..13) â†’ level(14..1) */
      function stepToLevel(step){
        const st = _clamp(Math.round(Number(step) || 0), 0, (TOTAL_STEPS - 1));
        return (MAX_LEVEL - st);
      }

      /* âœ… ratio(0~1, ì•„ë˜â†’ìœ„)ë¡œ thumb ìœ„ì¹˜ ì¦‰ì‹œ ë³´ì • */
      function positionThumb(ratio){
        const bar = document.querySelector(".zbar");
        const thumb = $("zoomThumb");
        if(!bar || !thumb) return;
        const rect = bar.getBoundingClientRect();
        const th   = thumb.offsetHeight || 6;
        let topPx  = rect.height * (1 - ratio) - th/2;
        if(topPx < 0) topPx = 0;
        const maxTop = rect.height - th;
        if(topPx > maxTop) topPx = maxTop;
        thumb.style.top = topPx + "px";
      }

      /* âœ” ëˆˆê¸ˆ: ë§¨ì•„ë˜(0) ì œì™¸, 2ìŠ¤í… ê°„ê²©ìœ¼ë¡œ ìµœìƒë‹¨ ì§ì „ê¹Œì§€ */
      function buildZoomGuides(){
        const box = $("zoomGuide");
        if(!box) return;
        box.innerHTML = "";
        for(let step = 2; step <= (TOTAL_STEPS - 2); step += 2){
          const ratio = step / (TOTAL_STEPS - 1);      // 0..1  (ì•„ë˜ 0 â†’ ìœ„ 1)
          const gt = document.createElement("div");
          gt.className = "gt";
          gt.style.bottom = (ratio * 100) + "%";
          gt.dataset.step = String(step);
          gt.style.cursor = "pointer";
          gt.addEventListener("click", (e)=>{
            e.stopPropagation();
            smoothZoomTo(stepToLevel(step));
          });
          box.appendChild(gt);
        }
      }

      /* ì§€ë„ ë ˆë²¨ê³¼ UI(ì±„ì›€, thumb) ë™ê¸°í™” â†’ ì´ í•¨ìˆ˜ë§Œ ì”ë‹ˆë‹¤ */
      function renderZoomUI(){
        const fill  = $("zoomFill");
        const step  = levelToStep(map.getLevel());   // 0..13
        const ratio = step / (TOTAL_STEPS - 1);      // 0..1
        if(fill) fill.style.height = (ratio * 100) + "%";
        positionThumb(ratio);
      }

      /* ====== ë§‰ëŒ€ ë“œë˜ê·¸: ì±„ì›€/ì†ì¡ì´ëŠ” ì¦‰ì‹œ, ì§€ë„ ì¤Œì€ ìŠ¤ë¡œí‹€ ====== */
      (function bindBarDrag(){
        const bar  = document.querySelector(".zbar");
        const fill = $("zoomFill");
        if(!bar || !fill) return;

        let dragging = false;
        let zoomTimer = null;
        let lastStepApplied = levelToStep(map.getLevel());
        let isDragging = false; // ì™¸ë¶€ì—ì„œ ì“°ì§€ ì•Šë„ë¡ ì§€ì—­í™”

        function posToState(clientY){
          const rect = bar.getBoundingClientRect();
          const y = _clamp(clientY, rect.top, rect.bottom);  // íŠ¸ë™ ë°– ì´ë™ ê¸ˆì§€
          const t = (y - rect.top) / rect.height;            // 0(top)..1(bottom)
          const step = Math.round((1 - t) * (TOTAL_STEPS - 1));
          return { t, step };
        }

        function applyStepToMap(step, anchor){
          const level = stepToLevel(step);
          if(level === map.getLevel()) return;
          try{ map.setLevel(level, { animate:true, anchor: anchor || map.getCenter() }); }
          catch(_){ map.setLevel(level); }
        }

        function updateFromClientY(clientY, immediateZoom){
          const { t, step } = posToState(clientY);
          const ratio = 1 - t;

          // âœ… í¬ì¸í„° ìœ„ì¹˜ì— ë§ì¶° fill + thumb ì¦‰ì‹œ ë™ê¸°í™”
          fill.style.height = (ratio * 100) + "%";
          positionThumb(ratio);

          // ì§€ë„ ì¤Œì€ ìŠ¤ë¡œí‹€
          if (immediateZoom){
            applyStepToMap(step, map.getCenter());
            lastStepApplied = step;
          } else if (step !== lastStepApplied){
            clearTimeout(zoomTimer);
            zoomTimer = setTimeout(()=>{
              applyStepToMap(step, map.getCenter());
              lastStepApplied = step;
            }, 60);
          }
        }

        function onPointerDown(e){
          dragging = true; isDragging = true;
          e.preventDefault();
          bar.classList.add("dragging");
          bar.setPointerCapture?.(e.pointerId);

          updateFromClientY(e.clientY, true);  // ì²« í”„ë ˆì„ ì¦‰ì‹œ ë°˜ì˜

          window.addEventListener("pointermove", onPointerMove);
          window.addEventListener("pointerup", onPointerUp, { once:true });
          window.addEventListener("pointercancel", onPointerUp, { once:true });
        }
        function onPointerMove(e){
          if(!dragging) return;
          e.preventDefault();
          updateFromClientY(e.clientY, false);
        }
        function onPointerUp(){
          dragging = false; isDragging = false;
          bar.classList.remove("dragging");
          window.removeEventListener("pointermove", onPointerMove);
          clearTimeout(zoomTimer);
          // ìµœì¢… ìŠ¤ëƒ…(ì§€ë„ ë ˆë²¨ ê¸°ì¤€ìœ¼ë¡œ í•œ ë²ˆ ë” ì •ë ¬)
          requestAnimationFrame(renderZoomUI);
        }

        bar.addEventListener("pointerdown", onPointerDown);
      })();

      /* íŠ¸ë™ ì•„ë¬´ ê³³ í´ë¦­í•´ë„ ìœ„ì¹˜ ë¹„ë¡€ ì¤Œ */
      (function bindTrackClick(){
        const center = $("zoomCenter");
        const bar    = document.querySelector(".zbar");
        const fill   = $("zoomFill");
        if(!center || !bar || !fill) return;

        center.addEventListener("click", (e)=>{
          e.stopPropagation();
          const rect = bar.getBoundingClientRect();
          const y = Math.min(Math.max(e.clientY, rect.top), rect.bottom);
          const t = (y - rect.top) / rect.height;           // 0..1
          const step = Math.round((1 - t) * (TOTAL_STEPS - 1));
          const ratio = 1 - t;

          // âœ… í´ë¦­ ì¦‰ì‹œ UI ë°˜ì˜
          fill.style.height = (ratio * 100) + "%";
          positionThumb(ratio);

          smoothZoomTo(stepToLevel(step));
        });
      })();

      /* + / â€“ ë²„íŠ¼ */
      on($("zoomPlus"),  "click", (e)=>{ e.stopPropagation(); smoothZoomTo(Math.max(MIN_LEVEL, map.getLevel() - 1)); });
      on($("zoomMinus"), "click", (e)=>{ e.stopPropagation(); smoothZoomTo(Math.min(MAX_LEVEL, map.getLevel() + 1)); });

      /* ì´ˆê¸°í™” */
      buildZoomGuides();
      renderZoomUI();
      kakao.maps.event.addListener(map, 'idle',         renderZoomUI);
      kakao.maps.event.addListener(map, 'zoom_changed', renderZoomUI);

      /* ===== ë§µíƒ€ì…(ì„¸ê·¸ë¨¼íŠ¸) â€” í•˜ì–€ í…Œë‘ë¦¬ ë³´ì´ëŠ” ë¬¸ì œ í•´ê²° ë²„ì „ ===== */
      const segWrap = $("segMapType");
      const segRoad = $("segRoad");
      const segSky  = $("segSky");

      function setMapTypeSeg(type){
        if (type === "road"){
          map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
          segWrap?.classList.add("is-road"); segWrap?.classList.remove("is-sky");
          segRoad?.setAttribute("aria-selected","true");
          segSky ?.setAttribute("aria-selected","false");
        }else{
          map.setMapTypeId(kakao.maps.MapTypeId.SKYVIEW);
          segWrap?.classList.add("is-sky");  segWrap?.classList.remove("is-road");
          segSky ?.setAttribute("aria-selected","true");
          segRoad?.setAttribute("aria-selected","false");
        }
      }
      on(segRoad, "click", (e)=>{ e.stopPropagation(); setMapTypeSeg("road"); });
      on(segSky,  "click", (e)=>{ e.stopPropagation(); setMapTypeSeg("sky");  });

      setMapTypeSeg("road");

      /* ===== ê³µí†µ ë§µ ì´ë²¤íŠ¸/ë°ì´í„° ë¡œë“œ ë“± ê¸°ì¡´ ì½”ë“œ ìœ ì§€ ===== */
      kakao.maps.event.addListener(map, 'click', function(){ closeOnlyCards(); closePlanInfoWins(); });

      google.script.run.withSuccessHandler(rebuildMarkers)
        .withFailureHandler(function(err){ console.error("[listings] load failed:",err); alert("ë§¤ë¬¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); })
        .fetchListings();

      google.script.run.withSuccessHandler(drawOverlays)
        .withFailureHandler(function(){ updateOverlayStat(0,0); })
        .fetchOverlays();

      bindAutoFilters();
      bindLayerPanel();
      bindLegendPanel();
      initSearchUI();
      bindTypeChips();

      // íƒ€ì¼: idle 2íšŒ í›„ ë¶€íŠ¸ í”Œë˜ê·¸
      (function () {
        let seen = 0;
        function onIdleTwice() {
          if (++seen >= 2) {
            kakao.maps.event.removeListener(map, 'idle', onIdleTwice);
            if (!BOOT.tiles) { BOOT.tiles = true; bootCheck(); }
          }
        }
        kakao.maps.event.addListener(map, 'idle', onIdleTwice);
      })();

      // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
      (function(){
        const btn=$("btnMenu"), sidebar=$("sidebar");
        if(btn && sidebar){
          btn.addEventListener("click",function(){
            const willOpen=!sidebar.classList.contains("open");
            sidebar.classList.toggle("open",willOpen);
          });
        }
      })();
    }

    // Kakao SDK ë™ì  ë¡œë“œ
    (function loadKakao(){
      google.script.run
        .withSuccessHandler(function(key){
          if(!key){ alert("ì¹´ì¹´ì˜¤ë§µ í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. config.gsì˜ KAKAO_JS_KEYë¥¼ í™•ì¸í•˜ì„¸ìš”."); return; }
          const cleanKey = String(key).trim();
          const url = "https://dapi.kakao.com/v2/maps/sdk.js?autoload=false&appkey=" + cleanKey + "&libraries=services,clusterer";
          const s = document.createElement("script");
          s.src = url;
          s.onload = function(){ if (window.kakao && kakao.maps) { kakao.maps.load(initApp); } else { alert("ì¹´ì¹´ì˜¤ SDK ë¡œë“œ ì‹¤íŒ¨(ê¶Œí•œ/ë„ë©”ì¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)."); } };
          s.onerror = function(e){ console.error("[Kakao SDK] onerror", e); alert("ì¹´ì¹´ì˜¤SDK ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); };
          document.head.appendChild(s);
        })
        .withFailureHandler(function(err){ console.error("[kakao key] load failed:", err); alert("ì¹´ì¹´ì˜¤ í‚¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); })
        .getKakaoKey();
    })();
  </script>
</body>
</html>